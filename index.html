<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ü–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞ ¬´–†–µ–Ω–µ—Å—Å–∞–Ω—Å¬ª ‚Äî –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è (1000+ —Å—Ç—Ä–æ–∫)</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    :root {
      --primary: #007bff;
      --success: #28a745;
      --danger: #dc3545;
      --warning: #ffc107;
      --light: #f8f9fa;
      --dark: #343a40;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f7fa;
      color: #333;
      line-height: 1.6;
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 20px;
    }
    header {
      background-color: var(--primary);
      color: white;
      padding: 16px 20px;
      text-align: center;
      border-radius: 8px 8px 0 0;
      margin-bottom: 22px;
      position: relative;
      box-shadow: 0 3px 8px rgba(0,0,0,0.12);
    }
    header h1 {
      font-size: 1.9rem;
      margin: 0;
    }
    header button {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      background-color: #ff6b6b;
      color: white;
      border: none;
      padding: 7px 14px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    header button:hover {
      background-color: #ff5252;
    }
    .hidden {
      display: none !important;
    }
    .card {
      background-color: white;
      padding: 22px;
      margin-bottom: 22px;
      border-radius: 10px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.09);
    }
    .tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 22px;
    }
    .tabs button {
      flex: 1;
      min-width: 130px;
      padding: 11px;
      background-color: #e9ecef;
      border: 1px solid #ced4da;
      border-radius: 7px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.25s;
    }
    .tabs button:hover {
      background-color: #dee2e6;
    }
    .tabs button.active {
      background-color: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    input,
    select,
    textarea,
    button {
      width: 100%;
      padding: 11px;
      margin: 7px 0;
      border: 1px solid #ced4da;
      border-radius: 5px;
      font-size: 1rem;
    }
    button {
      background-color: var(--primary);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover {
      opacity: 0.92;
    }
    .btn-success {
      background-color: var(--success);
    }
    .btn-warning {
      background-color: var(--warning);
      color: var(--dark);
    }
    .btn-danger {
      background-color: var(--danger);
    }
    .result {
      background-color: #eef6ff;
      padding: 16px;
      border-radius: 7px;
      margin-top: 16px;
      white-space: pre-wrap;
    }
    .doctor-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 18px;
      margin-top: 18px;
    }
    .doctor-card {
      border: 1px solid #e0e0e0;
      padding: 15px;
      border-radius: 9px;
      background-color: #fafafa;
      box-shadow: 0 2px 5px rgba(0,0,0,0.06);
    }
    .doctor-card h4 {
      margin: 0 0 9px 0;
      color: var(--dark);
      font-size: 1.1rem;
    }
    .doctor-card p {
      margin: 5px 0;
      font-size: 0.94rem;
    }
    .ticket {
      border: 2px dashed var(--primary);
      padding: 22px;
      margin: 22px 0;
      background-color: #f9f9ff;
      text-align: center;
      border-radius: 9px;
    }
    .ticket h3 {
      color: var(--primary);
      margin-bottom: 14px;
    }
    .ticket p {
      margin: 7px 0;
    }
    .ticket-id {
      font-size: 0.86rem;
      color: #666;
      margin-top: 14px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 14px;
    }
    th,
    td {
      padding: 11px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    th {
      background-color: #f8f9fa;
      font-weight: bold;
    }
    @media print {
      body * {
        visibility: hidden;
      }
      .ticket,
      .ticket * {
        visibility: visible;
      }
      .ticket {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        margin: 0;
        padding: 22px;
        box-sizing: border-box;
      }
      button {
        display: none !important;
      }
    }
    .footer-note {
      text-align: center;
      font-size: 0.87rem;
      color: #6c757d;
      margin-top: 32px;
      padding-top: 16px;
      border-top: 1px solid #eee;
    }
    .loading {
      text-align: center;
      padding: 20px;
      color: var(--primary);
    }
    .appointment-item {
      padding: 12px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      margin-bottom: 12px;
      background: #fafafa;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }
    .stat-card {
      background: white;
      padding: 16px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .stat-value {
      font-size: 1.8rem;
      font-weight: bold;
      color: var(--primary);
    }
  </style>
</head>
<body>

<!-- –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ -->
<div id="loginScreen" class="container">
  <div class="card" style="max-width: 440px; margin: 110px auto;">
    <h2 style="text-align: center; margin-bottom: 22px; color: var(--dark);">üîê –í—Ö–æ–¥ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>
    <input type="text" id="login" placeholder="–õ–æ–≥–∏–Ω" value="dem" autocomplete="off" />
    <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" value="0506" autocomplete="off" />
    <button onclick="login()">–í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</button>
    <p style="font-size: 13.5px; color: #666; margin-top: 16px; text-align: center;">
      –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —É—á—ë—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:<br>
      <b>–õ–æ–≥–∏–Ω:</b> dem &nbsp; | &nbsp; <b>–ü–∞—Ä–æ–ª—å:</b> 0506
    </p>
  </div>
</div>

<!-- –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ -->
<div id="mainApp" class="container hidden">
  <header>
    <h1>üè• –ü–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞ ¬´–†–µ–Ω–µ—Å—Å–∞–Ω—Å¬ª ‚Äî –ü–æ–ª–Ω–∞—è –∞–¥–º–∏–Ω–∫–∞</h1>
    <button onclick="logout()">–í—ã–π—Ç–∏</button>
  </header>

  <div class="tabs">
    <button class="tab-btn active" data-tab="dashboard">üìä –ü–∞–Ω–µ–ª—å</button>
    <button class="tab-btn" data-tab="doctors">üë®‚Äç‚öïÔ∏è –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ (18)</button>
    <button class="tab-btn" data-tab="register">‚ûï –ü–∞—Ü–∏–µ–Ω—Ç—ã</button>
    <button class="tab-btn" data-tab="appointment">üìÖ –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</button>
    <button class="tab-btn" data-tab="myAppointments">üìã –ú–æ–∏ –∑–∞–ø–∏—Å–∏</button>
    <button class="tab-btn" data-tab="medical">ü©∫ –ú–µ–¥–∫–∞—Ä—Ç–∞</button>
    <button class="tab-btn" data-tab="tickets">üé´ –¢–∞–ª–æ–Ω—ã</button>
  </div>

  <!-- –ü–ê–ù–ï–õ–¨ -->
  <div id="dashboard" class="card tab-content active">
    <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∏</h3>
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="statPatients">‚Äî</div>
        <div>–ü–∞—Ü–∏–µ–Ω—Ç–æ–≤</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statAppointments">‚Äî</div>
        <div>–ó–∞–ø–∏—Å–µ–π —Å–µ–≥–æ–¥–Ω—è</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statDoctors">‚Äî</div>
        <div>–í—Ä–∞—á–µ–π</div>
      </div>
    </div>
    <p style="margin-top: 20px;">–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ. –ü–æ—Å–ª–µ–¥–Ω—è—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: <span id="lastInit">–Ω–∏–∫–æ–≥–¥–∞</span>.</p>
  </div>

  <!-- –°–û–¢–†–£–î–ù–ò–ö–ò -->
  <div id="doctors" class="card tab-content hidden">
    <h3>–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∏ (18 —á–µ–ª–æ–≤–µ–∫)</h3>
    <p>10 –≤—Ä–∞—á–µ–π, 5 —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤, 3 –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞. –ì—Ä–∞—Ñ–∏–∫ –Ω–∞ 365 –¥–Ω–µ–π (–ø–Ω‚Äì–ø—Ç).</p>
    <div id="doctorsList" class="loading">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
  </div>

  <!-- –ü–ê–¶–ò–ï–ù–¢–´ -->
  <div id="register" class="card tab-content hidden">
    <h3>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è / –ø–æ–∏—Å–∫ –ø–∞—Ü–∏–µ–Ω—Ç–∞</h3>
    <input id="regFio" placeholder="–§–ò–û –ø–æ–ª–Ω–æ—Å—Ç—å—é" />
    <input id="regBirth" type="date" />
    <select id="regGender"><option value="">–ü–æ–ª</option><option value="–ú">–ú—É–∂—Å–∫–æ–π</option><option value="–ñ">–ñ–µ–Ω—Å–∫–∏–π</option></select>
    <input id="regPhone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" />
    <input id="regEmail" placeholder="Email" type="email" />
    <input id="regAddress" placeholder="–ê–¥—Ä–µ—Å" />
    <input id="regPassport" placeholder="–ü–∞—Å–ø–æ—Ä—Ç (4507 123456)" />
    <input id="regSnils" placeholder="–°–ù–ò–õ–°" />
    <input id="regInn" placeholder="–ò–ù–ù" />
    <button class="btn-success" onclick="registerPatient()">‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å</button>

    <h4 style="margin-top: 25px;">–ü–æ–∏—Å–∫ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h4>
    <input id="searchQuery" placeholder="–§–ò–û, –ø–∞—Å–ø–æ—Ä—Ç, –°–ù–ò–õ–°..." />
    <button onclick="searchPatient()">–ù–∞–π—Ç–∏</button>
    <div id="searchResult" class="result"></div>
    <div id="editForm" class="hidden">
      <input id="editKey" type="hidden" />
      <input id="editFio" placeholder="–§–ò–û" />
      <input id="editBirth" type="date" />
      <select id="editGender"><option value="">–ü–æ–ª</option><option value="–ú">–ú—É–∂—Å–∫–æ–π</option><option value="–ñ">–ñ–µ–Ω—Å–∫–∏–π</option></select>
      <input id="editPhone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" />
      <input id="editEmail" placeholder="Email" />
      <input id="editAddress" placeholder="–ê–¥—Ä–µ—Å" />
      <input id="editPassport" placeholder="–ü–∞—Å–ø–æ—Ä—Ç" />
      <input id="editSnils" placeholder="–°–ù–ò–õ–°" />
      <input id="editInn" placeholder="–ò–ù–ù" />
      <button class="btn-success" onclick="savePatient()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button class="btn-danger" onclick="deletePatient()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
      <button onclick="cancelEdit()">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>

  <!-- –ù–û–í–ê–Ø –ó–ê–ü–ò–°–¨ -->
  <div id="appointment" class="card tab-content hidden">
    <h3>–ó–∞–ø–∏—Å—å –Ω–∞ –ø—Ä–∏—ë–º</h3>
    <input id="appPassport" placeholder="–ü–∞—Å–ø–æ—Ä—Ç –ø–∞—Ü–∏–µ–Ω—Ç–∞" />
    <select id="appDoctor"><option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–∞—á–∞ ‚Äî</option></select>
    <input id="appDate" type="date" />
    <select id="appTime"><option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è ‚Äî</option></select>
    <button class="btn-success" onclick="bookAppointment()">üìÖ –ó–∞–ø–∏—Å–∞—Ç—å</button>
    <div id="appResult" class="result"></div>
  </div>

  <!-- –ú–û–ò –ó–ê–ü–ò–°–ò (–†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –ò –û–¢–ú–ï–ù–ê) -->
  <div id="myAppointments" class="card tab-content hidden">
    <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å—è–º–∏</h3>
    <p>–í–≤–µ–¥–∏—Ç–µ –ø–∞—Å–ø–æ—Ä—Ç –∏–ª–∏ –§–ò–û –ø–∞—Ü–∏–µ–Ω—Ç–∞, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –∏ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å.</p>
    <input id="managePassport" placeholder="–ü–∞—Å–ø–æ—Ä—Ç –∏–ª–∏ –§–ò–û" />
    <button onclick="findAppointments()">–ù–∞–π—Ç–∏ –∑–∞–ø–∏—Å–∏</button>
    <div id="appointmentsList" class="result"></div>
  </div>

  <!-- –ú–ï–î–ö–ê–†–¢–ê -->
  <div id="medical" class="card tab-content hidden">
    <h3>–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –∫–∞—Ä—Ç–∞</h3>
    <input id="medPassport" placeholder="–ü–∞—Å–ø–æ—Ä—Ç –ø–∞—Ü–∏–µ–Ω—Ç–∞" />
    <button onclick="loadMedicalRecord()">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
    <div id="medicalData" class="result"></div>

    <h4 style="margin-top: 22px;">–ù–æ–≤–æ–µ –ø–æ—Å–µ—â–µ–Ω–∏–µ</h4>
    <textarea id="medDiagnosis" placeholder="–î–∏–∞–≥–Ω–æ–∑" rows="2"></textarea>
    <textarea id="medConclusion" placeholder="–ó–∞–∫–ª—é—á–µ–Ω–∏–µ" rows="3"></textarea>
    <textarea id="medPrescription" placeholder="–ù–∞–∑–Ω–∞—á–µ–Ω–∏—è" rows="2"></textarea>
    <button class="btn-success" onclick="addMedicalVisit()">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
  </div>

  <!-- –¢–ê–õ–û–ù–´ -->
  <div id="tickets" class="card tab-content hidden">
    <h3>–ü–µ—á–∞—Ç—å —Ç–∞–ª–æ–Ω–∞</h3>
    <p>–¢–∞–ª–æ–Ω –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–ø–∏—Å–∏.</p>
    <div id="ticketContainer"></div>
  </div>

  <div class="footer-note">
    –ü–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞ ¬´–†–µ–Ω–µ—Å—Å–∞–Ω—Å¬ª ‚Äî –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è | 18 —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ | –ì—Ä–∞—Ñ–∏–∫ –Ω–∞ 365 –¥–Ω–µ–π | ¬© 2025
  </div>
</div>

<script>
  // === Firebase ===
  const firebaseConfig = {
    databaseURL: "https://renessans-bank-3df94-default-rtdb.europe-west1.firebasedatabase.app/"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // === –í—Ö–æ–¥ ===
  function login() {
    const l = document.getElementById("login").value.trim();
    const p = document.getElementById("password").value.trim();
    if (l === "dem" && p === "0506") {
      document.getElementById("loginScreen").classList.add("hidden");
      document.getElementById("mainApp").classList.remove("hidden");
      initializeFullSystem();
      loadStats();
    } else {
      alert("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å.");
    }
  }

  function logout() {
    document.getElementById("mainApp").classList.add("hidden");
    document.getElementById("loginScreen").classList.remove("hidden");
  }

  // === –í–∫–ª–∞–¥–∫–∏ ===
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        btn.classList.add('active');
        document.getElementById(btn.dataset.tab).classList.remove('hidden');
      });
    });
  });

  // === –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –§–ò–û ===
  const firstNamesM = ["–ê–ª–µ–∫—Å–∞–Ω–¥—Ä", "–î–º–∏—Ç—Ä–∏–π", "–°–µ—Ä–≥–µ–π", "–ê–Ω–¥—Ä–µ–π", "–ò–≤–∞–Ω", "–ú–∏—Ö–∞–∏–ª", "–ù–∏–∫–æ–ª–∞–π", "–í–ª–∞–¥–∏–º–∏—Ä", "–ü–∞–≤–µ–ª", "–ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏–Ω"];
  const firstNamesF = ["–ê–Ω–Ω–∞", "–ï–ª–µ–Ω–∞", "–û–ª—å–≥–∞", "–ù–∞—Ç–∞–ª—å—è", "–ò—Ä–∏–Ω–∞", "–°–≤–µ—Ç–ª–∞–Ω–∞", "–¢–∞—Ç—å—è–Ω–∞", "–ú–∞—Ä–∏–Ω–∞", "–ï–∫–∞—Ç–µ—Ä–∏–Ω–∞", "–ê–ª—ë–Ω–∞"];
  const lastNames = ["–ò–≤–∞–Ω–æ–≤", "–°–º–∏—Ä–Ω–æ–≤", "–ö—É–∑–Ω–µ—Ü–æ–≤", "–ü–æ–ø–æ–≤", "–í–∞—Å–∏–ª—å–µ–≤", "–ü–µ—Ç—Ä–æ–≤", "–°–æ–∫–æ–ª–æ–≤", "–ú–∏—Ö–∞–π–ª–æ–≤", "–ù–æ–≤–∏–∫–æ–≤", "–§—ë–¥–æ—Ä–æ–≤"];
  const patronymicsM = ["–ê–ª–µ–∫—Å–∞–Ω–¥—Ä–æ–≤–∏—á", "–î–º–∏—Ç—Ä–∏–µ–≤–∏—á", "–°–µ—Ä–≥–µ–µ–≤–∏—á", "–ê–Ω–¥—Ä–µ–µ–≤–∏—á", "–ò–≤–∞–Ω–æ–≤–∏—á", "–ú–∏—Ö–∞–π–ª–æ–≤–∏—á", "–ù–∏–∫–æ–ª–∞–µ–≤–∏—á", "–í–ª–∞–¥–∏–º–∏—Ä–æ–≤–∏—á", "–ü–∞–≤–ª–æ–≤–∏—á", "–ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏–Ω–æ–≤–∏—á"];
  const patronymicsF = ["–ê–ª–µ–∫—Å–∞–Ω–¥—Ä–æ–≤–Ω–∞", "–î–º–∏—Ç—Ä–∏–µ–≤–Ω–∞", "–°–µ—Ä–≥–µ–µ–≤–Ω–∞", "–ê–Ω–¥—Ä–µ–µ–≤–Ω–∞", "–ò–≤–∞–Ω–æ–≤–Ω–∞", "–ú–∏—Ö–∞–π–ª–æ–≤–Ω–∞", "–ù–∏–∫–æ–ª–∞–µ–≤–Ω–∞", "–í–ª–∞–¥–∏–º–∏—Ä–æ–≤–Ω–∞", "–ü–∞–≤–ª–æ–≤–Ω–∞", "–ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏–Ω–æ–≤–Ω–∞"];
  const specialties = ["–¢–µ—Ä–∞–ø–µ–≤—Ç", "–•–∏—Ä—É—Ä–≥", "–û—Ñ—Ç–∞–ª—å–º–æ–ª–æ–≥", "–ì–∏–Ω–µ–∫–æ–ª–æ–≥", "–ö–∞—Ä–¥–∏–æ–ª–æ–≥", "–ù–µ–≤—Ä–æ–ª–æ–≥", "–î–µ—Ä–º–∞—Ç–æ–ª–æ–≥", "–≠–Ω–¥–æ–∫—Ä–∏–Ω–æ–ª–æ–≥", "–ü–µ–¥–∏–∞—Ç—Ä", "–û—Ç–æ—Ä–∏–Ω–æ–ª–∞—Ä–∏–Ω–≥–æ–ª–æ–≥"];

  // === –ì—Ä–∞—Ñ–∏–∫ –Ω–∞ 365 –¥–Ω–µ–π ===
  function generateSchedule365() {
    const schedule = {};
    const today = new Date();
    const slots = ["09:00", "10:00", "11:00", "12:00", "14:00", "15:00", "16:00", "17:00"];
    for (let i = 0; i < 365; i++) {
      const d = new Date(today);
      d.setDate(d.getDate() + i);
      const day = d.getDay();
      if (day === 0 || day === 6) continue;
      const dateStr = d.toISOString().split('T')[0];
      schedule[dateStr] = [...slots];
    }
    return schedule;
  }

  // === –ì–µ–Ω–µ—Ä–∞—Ü–∏—è 18 —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ ===
  function generateStaff() {
    const staff = {};
    const fullSchedule = generateSchedule365();
    // 10 –≤—Ä–∞—á–µ–π
    for (let i = 1; i <= 10; i++) {
      const isMale = Math.random() > 0.5;
      const firstName = isMale ? firstNamesM[Math.floor(Math.random() * firstNamesM.length)] : firstNamesF[Math.floor(Math.random() * firstNamesF.length)];
      const patronymic = isMale ? patronymicsM[Math.floor(Math.random() * patronymicsM.length)] : patronymicsF[Math.floor(Math.random() * patronymicsF.length)];
      const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
      const fio = `${lastName} ${firstName} ${patronymic}`;
      const specialty = specialties[Math.floor(Math.random() * specialties.length)];
      const experience = Math.floor(Math.random() * 20) + 5;
      staff[`doc${i.toString().padStart(2, '0')}`] = {
        fio, specialty, experience: `${experience} –ª–µ—Ç`, role: "doctor", schedule: fullSchedule
      };
    }
    // 5 —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
    for (let i = 1; i <= 5; i++) {
      const fio = `${lastNames[Math.floor(Math.random() * lastNames.length)]} ${firstNamesF[Math.floor(Math.random() * firstNamesF.length)]} ${patronymicsF[Math.floor(Math.random() * patronymicsF.length)]}`;
      staff[`reg${i}`] = { fio, role: "registrar", specialty: "–†–µ–≥–∏—Å—Ç—Ä–∞—Ç–æ—Ä" };
    }
    // 3 –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    for (let i = 1; i <= 3; i++) {
      const fio = `${lastNames[Math.floor(Math.random() * lastNames.length)]} ${firstNamesM[Math.floor(Math.random() * firstNamesM.length)]} ${patronymicsM[Math.floor(Math.random() * patronymicsM.length)]}`;
      staff[`adm${i}`] = { fio, role: "admin", specialty: "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä" };
    }
    return staff;
  }

  // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ===
  function initializeFullSystem() {
    const listDiv = document.getElementById("doctorsList");
    listDiv.innerHTML = "–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö...";

    db.ref("staff").once("value")
      .then(snapshot => {
        if (snapshot.exists() && Object.keys(snapshot.val()).length >= 18) {
          listDiv.innerHTML = "‚úÖ –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ —É–∂–µ —Å–æ–∑–¥–∞–Ω—ã.";
          loadDoctorsUI();
          loadDoctorsToSelect();
          document.getElementById("lastInit").textContent = "—É–∂–µ –±—ã–ª–∞";
          return;
        }

        listDiv.innerHTML = "üîÑ –°–æ–∑–¥–∞–Ω–∏–µ 18 —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏ –≥—Ä–∞—Ñ–∏–∫–∞ –Ω–∞ 365 –¥–Ω–µ–π...";
        const staff = generateStaff();
        return db.ref("staff").set(staff);
      })
      .then(() => {
        listDiv.innerHTML = "‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!";
        document.getElementById("lastInit").textContent = new Date().toLocaleString();
        setTimeout(() => {
          loadDoctorsUI();
          loadDoctorsToSelect();
        }, 800);
      })
      .catch(error => {
        console.error("–û—à–∏–±–∫–∞:", error);
        listDiv.innerHTML = "‚ùå –û—à–∏–±–∫–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ Firebase.";
      });
  }

  // === –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Ä–∞—á–µ–π –≤ UI ===
  function loadDoctorsUI() {
    const container = document.getElementById("doctorsList");
    container.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞...";
    db.ref("staff").once("value")
      .then(snapshot => {
        container.innerHTML = "";
        let count = 0;
        snapshot.forEach(doc => {
          const d = doc.val();
          if (d.role !== "doctor") return;
          const dates = Object.keys(d.schedule || {}).sort();
          const next = dates.slice(0, 2).join(", ");
          const card = document.createElement("div");
          card.className = "doctor-card";
          card.innerHTML = `<h4>${d.fio}</h4><p><strong>${d.specialty}</strong></p><p>–°—Ç–∞–∂: ${d.experience}</p><p>–ë–ª–∏–∂–∞–π—à–∏–µ: ${next || "‚Äî"}</p>`;
          container.appendChild(card);
          count++;
        });
      });
  }

  // === –ó–∞–≥—Ä—É–∑–∫–∞ –≤ —Å–µ–ª–µ–∫—Ç ===
  function loadDoctorsToSelect() {
    const sel = document.getElementById("appDoctor");
    if (!sel) return;
    sel.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–∞—á–∞ ‚Äî</option>';
    db.ref("staff").once("value")
      .then(snapshot => {
        snapshot.forEach(doc => {
          const d = doc.val();
          if (d.role === "doctor") {
            const opt = document.createElement("option");
            opt.value = doc.key;
            opt.textContent = `${d.fio} (${d.specialty})`;
            sel.appendChild(opt);
          }
        });
      });
  }

  // === –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–∞—Ü–∏–µ–Ω—Ç–∞ ===
  function registerPatient() {
    const fio = document.getElementById("regFio").value.trim();
    const birth = document.getElementById("regBirth").value;
    const gender = document.getElementById("regGender").value;
    const phone = document.getElementById("regPhone").value.trim();
    const email = document.getElementById("regEmail").value.trim();
    const address = document.getElementById("regAddress").value.trim();
    const passport = document.getElementById("regPassport").value.trim();
    const snils = document.getElementById("regSnils").value.trim();
    const inn = document.getElementById("regInn").value.trim();

    if (!fio || !passport || !birth) {
      alert("‚ùå –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ: –§–ò–û, –ø–∞—Å–ø–æ—Ä—Ç, –¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è.");
      return;
    }

    const key = passport.replace(/\s+/g, "_");
    db.ref("patients/" + key).set({
      fio, birth, gender, phone, email, address, passport, snils, inn,
      createdAt: new Date().toISOString()
    }).then(() => {
      alert("‚úÖ –ü–∞—Ü–∏–µ–Ω—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω!");
      document.querySelectorAll("#register input").forEach(el => el.value = "");
    });
  }

  // === –ü–æ–∏—Å–∫ –ø–∞—Ü–∏–µ–Ω—Ç–∞ ===
  function searchPatient() {
    const q = document.getElementById("searchQuery").value.trim().toLowerCase();
    if (!q) return alert("–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ.");

    db.ref("patients").once("value")
      .then(snapshot => {
        let found = null;
        snapshot.forEach(p => {
          const pat = p.val();
          const fields = [pat.fio, pat.passport, pat.snils, pat.phone, pat.email, pat.address];
          if (fields.some(f => f && f.toLowerCase().includes(q))) {
            found = { key: p.key, ...pat };
            return false;
          }
        });

        const res = document.getElementById("searchResult");
        const edit = document.getElementById("editForm");
        if (found) {
          res.innerHTML = `<p><b>${found.fio}</b><br>–ü–∞—Å–ø–æ—Ä—Ç: ${found.passport}</p>`;
          document.getElementById("editKey").value = found.key;
          document.getElementById("editFio").value = found.fio || '';
          document.getElementById("editBirth").value = found.birth || '';
          document.getElementById("editGender").value = found.gender || '';
          document.getElementById("editPhone").value = found.phone || '';
          document.getElementById("editEmail").value = found.email || '';
          document.getElementById("editAddress").value = found.address || '';
          document.getElementById("editPassport").value = found.passport || '';
          document.getElementById("editSnils").value = found.snils || '';
          document.getElementById("editInn").value = found.inn || '';
          edit.classList.remove("hidden");
        } else {
          res.innerHTML = "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω";
          edit.classList.add("hidden");
        }
      });
  }

  // === –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π ===
  function savePatient() {
    const key = document.getElementById("editKey").value;
    if (!key) return alert("‚ùå –û—à–∏–±–∫–∞ –∫–ª—é—á–∞.");

    const data = {
      fio: document.getElementById("editFio").value.trim(),
      birth: document.getElementById("editBirth").value,
      gender: document.getElementById("editGender").value,
      phone: document.getElementById("editPhone").value.trim(),
      email: document.getElementById("editEmail").value.trim(),
      address: document.getElementById("editAddress").value.trim(),
      passport: document.getElementById("editPassport").value.trim(),
      snils: document.getElementById("editSnils").value.trim(),
      inn: document.getElementById("editInn").value.trim()
    };

    if (!data.fio || !data.passport) return alert("‚ùå –§–ò–û –∏ –ø–∞—Å–ø–æ—Ä—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã.");

    db.ref("patients/" + key).update(data).then(() => {
      alert("‚úÖ –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!");
      cancelEdit();
    });
  }

  // === –£–¥–∞–ª–µ–Ω–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞ ===
  function deletePatient() {
    if (!confirm("–£–¥–∞–ª–∏—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞ –∏ –≤—Å–µ –µ–≥–æ –∑–∞–ø–∏—Å–∏?")) return;
    const key = document.getElementById("editKey").value;
    db.ref("patients/" + key).remove()
      .then(() => {
        alert("‚úÖ –ü–∞—Ü–∏–µ–Ω—Ç —É–¥–∞–ª—ë–Ω.");
        cancelEdit();
      });
  }

  function cancelEdit() {
    document.getElementById("editForm").classList.add("hidden");
    document.getElementById("searchQuery").value = "";
    document.getElementById("searchResult").innerHTML = "";
  }

  // === –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ ===
  document.addEventListener("DOMContentLoaded", () => {
    const docSel = document.getElementById("appDoctor");
    const dateInp = document.getElementById("appDate");
    if (docSel && dateInp) {
      docSel.addEventListener("change", updateAvailableTimes);
      dateInp.addEventListener("change", updateAvailableTimes);
    }
  });

  function updateAvailableTimes() {
    const docId = document.getElementById("appDoctor")?.value;
    const date = document.getElementById("appDate")?.value;
    const timeSel = document.getElementById("appTime");
    if (!docId || !date || !timeSel) return;

    timeSel.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è ‚Äî</option>';

    db.ref(`staff/${docId}/schedule/${date}`).once("value")
      .then(snap => {
        const all = snap.val() || [];
        if (all.length === 0) {
          timeSel.innerHTML = '<option value="">–ù–µ—Ç —Ä–∞–±–æ—á–∏—Ö —Å–ª–æ—Ç–æ–≤</option>';
          return;
        }
        return db.ref("appointments").orderByChild("doctorDate").equalTo(`${docId}_${date}`).once("value")
          .then(appts => {
            const busy = {};
            appts.forEach(a => { busy[a.val().time] = true; });
            return { all, busy };
          });
      })
      .then(({ all, busy }) => {
        let hasFree = false;
        all.filter(t => !busy[t]).forEach(t => {
          const opt = document.createElement("option");
          opt.value = t;
          opt.textContent = t;
          timeSel.appendChild(opt);
          hasFree = true;
        });
        if (!hasFree) {
          timeSel.innerHTML = '<option value="">–í—Å–µ —Å–ª–æ—Ç—ã –∑–∞–Ω—è—Ç—ã</option>';
        }
      })
      .catch(err => {
        timeSel.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
      });
  }

  // === –ó–∞–ø–∏—Å—å ===
  function bookAppointment() {
    const passport = document.getElementById("appPassport")?.value.trim();
    const docId = document.getElementById("appDoctor")?.value;
    const date = document.getElementById("appDate")?.value;
    const time = document.getElementById("appTime")?.value;
    if (!passport || !docId || !date || !time) return alert("‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è.");

    const key = `${date}_${docId}_${time}`;
    const ticketId = "T" + Date.now().toString(36).toUpperCase();

    db.ref("appointments/" + key).set({
      patientPassport: passport,
      doctorId: docId,
      date, time,
      ticketId,
      doctorDate: `${docId}_${date}`,
      status: "confirmed",
      createdAt: new Date().toISOString()
    }).then(() => {
      document.getElementById("appResult").innerHTML = "‚úÖ –ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞!";
      showTicket(passport, docId, date, time, ticketId);
      updateAvailableTimes();
    });
  }

  // === –¢–∞–ª–æ–Ω ===
  function showTicket(passport, doctorId, date, time, ticketId) {
    Promise.all([
      db.ref("patients/" + passport.replace(/\s+/g, "_")).once("value"),
      db.ref("staff/" + doctorId).once("value")
    ]).then(([patSnap, docSnap]) => {
      const pat = patSnap.val();
      const doc = docSnap.val();
      document.getElementById("ticketContainer").innerHTML = `
        <div class="ticket">
          <h3>–¢–∞–ª–æ–Ω –Ω–∞ –ø—Ä–∏—ë–º</h3>
          <p><strong>–ü–∞—Ü–∏–µ–Ω—Ç:</strong> ${pat?.fio || '‚Äî'}</p>
          <p><strong>–í—Ä–∞—á:</strong> ${doc?.fio || '‚Äî'} (${doc?.specialty || '‚Äî'})</p>
          <p><strong>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è:</strong> ${date} –≤ ${time}</p>
          <p><strong>–ö–∞–±–∏–Ω–µ—Ç:</strong> 305</p>
          <p class="ticket-id">ID: ${ticketId}</p>
        </div>
        <button onclick="window.print()">üñ®Ô∏è –†–∞—Å–ø–µ—á–∞—Ç–∞—Ç—å</button>
      `;
      document.querySelector('.tab-btn[data-tab="tickets"]').click();
    });
  }

  // === –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å—è–º–∏ ===
  function findAppointments() {
    const query = document.getElementById("managePassport").value.trim().toLowerCase();
    if (!query) return alert("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Å–ø–æ—Ä—Ç –∏–ª–∏ –§–ò–û.");

    Promise.all([
      db.ref("patients").once("value"),
      db.ref("appointments").once("value"),
      db.ref("staff").once("value")
    ]).then(([patSnap, appSnap, staffSnap]) => {
      const patients = {};
      patSnap.forEach(p => {
        const pat = p.val();
        if (pat.passport.toLowerCase().includes(query) || pat.fio.toLowerCase().includes(query)) {
          patients[p.key] = pat;
        }
      });

      if (Object.keys(patients).length === 0) {
        document.getElementById("appointmentsList").innerHTML = "<p>‚ùå –ü–∞—Ü–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.</p>";
        return;
      }

      const appointments = [];
      appSnap.forEach(a => {
        const app = a.val();
        if (patients[app.patientPassport.replace(/\s+/g, "_")]) {
          appointments.push({ key: a.key, ...app });
        }
      });

      if (appointments.length === 0) {
        document.getElementById("appointmentsList").innerHTML = "<p>–£ –ø–∞—Ü–∏–µ–Ω—Ç–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π.</p>";
        return;
      }

      let html = "<h4>–ù–∞–π–¥–µ–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏:</h4>";
      appointments.forEach(app => {
        const pat = patients[app.patientPassport.replace(/\s+/g, "_")];
        const doctor = staffSnap.val()[app.doctorId] || {};
        html += `
          <div class="appointment-item">
            <p><b>${pat.fio}</b> ‚Üí ${doctor.fio || '‚Äî'} (${doctor.specialty || '‚Äî'})</p>
            <p>üìÖ ${app.date} –≤ ${app.time} | ID: ${app.ticketId}</p>
            <button class="btn-warning" onclick="editAppointment('${app.key}', '${app.patientPassport}', '${app.doctorId}', '${app.date}', '${app.time}')">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</button>
            <button class="btn-danger" onclick="cancelAppointment('${app.key}')">‚ùå –û—Ç–º–µ–Ω–∏—Ç—å</button>
          </div>
        `;
      });
      document.getElementById("appointmentsList").innerHTML = html;
    });
  }

  // === –û—Ç–º–µ–Ω–∞ –∑–∞–ø–∏—Å–∏ ===
  function cancelAppointment(key) {
    if (!confirm("–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å?")) return;
    db.ref("appointments/" + key).remove()
      .then(() => {
        alert("‚úÖ –ó–∞–ø–∏—Å—å –æ—Ç–º–µ–Ω–µ–Ω–∞. –í—Ä–µ–º—è –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–æ.");
        findAppointments(); // –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫
      });
  }

  // === –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ ===
  function editAppointment(key, passport, doctorId, date, time) {
    const container = document.getElementById("appointmentsList");
    container.innerHTML = `
      <h4>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏</h4>
      <input id="editAppPassport" value="${passport}" placeholder="–ü–∞—Å–ø–æ—Ä—Ç" />
      <select id="editAppDoctor"></select>
      <input id="editAppDate" type="date" value="${date}" />
      <select id="editAppTime"><option value="${time}" selected>${time}</option></select>
      <button class="btn-success" onclick="saveEditedAppointment('${key}')">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button onclick="findAppointments()">–û—Ç–º–µ–Ω–∞</button>
    `;
    // –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Ä–∞—á–µ–π
    const sel = document.getElementById("editAppDoctor");
    db.ref("staff").once("value").then(staffSnap => {
      staffSnap.forEach(doc => {
        const d = doc.val();
        if (d.role === "doctor") {
          const opt = document.createElement("option");
          opt.value = doc.key;
          opt.textContent = `${d.fio} (${d.specialty})`;
          if (doc.key === doctorId) opt.selected = true;
          sel.appendChild(opt);
        }
      });
    });
    // –û–±–Ω–æ–≤–∏—Ç—å –≤—Ä–µ–º—è –ø—Ä–∏ —Å–º–µ–Ω–µ –¥–∞—Ç—ã/–≤—Ä–∞—á–∞
    document.getElementById("editAppDoctor").addEventListener("change", () => updateEditTime());
    document.getElementById("editAppDate").addEventListener("change", () => updateEditTime());
    updateEditTime(doctorId, date, time);
  }

  function updateEditTime(currentDoc, currentDate, currentTime) {
    const docId = document.getElementById("editAppDoctor")?.value || currentDoc;
    const date = document.getElementById("editAppDate")?.value || currentDate;
    const sel = document.getElementById("editAppTime");
    sel.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>';

    db.ref(`staff/${docId}/schedule/${date}`).once("value")
      .then(snap => {
        const all = snap.val() || [];
        return db.ref("appointments").orderByChild("doctorDate").equalTo(`${docId}_${date}`).once("value")
          .then(appts => {
            const busy = {};
            appts.forEach(a => {
              // –ù–µ —Å—á–∏—Ç–∞—Ç—å —Ç–µ–∫—É—â—É—é –∑–∞–ø–∏—Å—å –∫–∞–∫ –∑–∞–Ω—è—Ç—É—é
              if (a.key !== currentKeyForEdit) busy[a.val().time] = true;
            });
            return { all, busy };
          });
      })
      .then(({ all, busy }) => {
        sel.innerHTML = "";
        all.forEach(t => {
          const opt = document.createElement("option");
          opt.value = t;
          opt.textContent = t;
          if (t === currentTime) opt.selected = true;
          sel.appendChild(opt);
        });
      });
  }

  let currentKeyForEdit = "";
  function saveEditedAppointment(key) {
    currentKeyForEdit = key;
    const passport = document.getElementById("editAppPassport").value.trim();
    const doctorId = document.getElementById("editAppDoctor").value;
    const date = document.getElementById("editAppDate").value;
    const time = document.getElementById("editAppTime").value;
    if (!passport || !doctorId || !date || !time) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è.");

    const newKey = `${date}_${doctorId}_${time}`;
    const oldData = db.ref("appointments/" + key);
    oldData.once("value").then(snapshot => {
      const old = snapshot.val();
      const newData = {
        patientPassport: passport,
        doctorId,
        date,
        time,
        ticketId: old.ticketId,
        doctorDate: `${doctorId}_${date}`,
        status: "confirmed",
        createdAt: old.createdAt
      };

      // –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—É—é, —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é
      return db.ref("appointments").update({
        [key]: null,
        [newKey]: newData
      });
    }).then(() => {
      alert("‚úÖ –ó–∞–ø–∏—Å—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞!");
      findAppointments();
    });
  }

  // === –ú–µ–¥–∫–∞—Ä—Ç–∞ ===
  function loadMedicalRecord() {
    const passport = document.getElementById("medPassport")?.value.trim();
    if (!passport) return alert("–£–∫–∞–∂–∏—Ç–µ –ø–∞—Å–ø–æ—Ä—Ç.");
    const key = passport.replace(/\s+/g, "_");
    db.ref("medicalRecords/" + key).once("value")
      .then(snap => {
        const data = snap.val();
        const div = document.getElementById("medicalData");
        if (!data || !data.visits || data.visits.length === 0) {
          div.innerHTML = "<p>–ú–µ–¥–∫–∞—Ä—Ç–∞ –ø—É—Å—Ç–∞.</p>";
          return;
        }
        div.innerHTML = data.visits.reverse().map(v => 
          `<p><b>${v.date}</b><br>ü©∫ ${v.diagnosis || '‚Äî'}<br>üìù ${v.conclusion || '‚Äî'}<br>üíä ${v.prescription || '‚Äî'}</p><hr>`
        ).join("");
      });
  }

  function addMedicalVisit() {
    const passport = document.getElementById("medPassport")?.value.trim();
    const diagnosis = document.getElementById("medDiagnosis")?.value.trim();
    const conclusion = document.getElementById("medConclusion")?.value.trim();
    const prescription = document.getElementById("medPrescription")?.value.trim();
    if (!passport) return alert("–£–∫–∞–∂–∏—Ç–µ –ø–∞—Å–ø–æ—Ä—Ç.");

    const key = passport.replace(/\s+/g, "_");
    const newVisit = {
      date: new Date().toISOString().split('T')[0],
      diagnosis,
      conclusion,
      prescription,
      doctor: "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä",
      timestamp: Date.now()
    };

    db.ref("medicalRecords/" + key).transaction(record => {
      if (!record) record = { visits: [] };
      record.visits.push(newVisit);
      return record;
    }).then(() => {
      alert("‚úÖ –ó–∞–ø–∏—Å—å –¥–æ–±–∞–≤–ª–µ–Ω–∞!");
      loadMedicalRecord();
      ["medDiagnosis", "medConclusion", "medPrescription"].forEach(id => {
        document.getElementById(id).value = "";
      });
    });
  }

  // === –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ===
  function loadStats() {
    db.ref("patients").once("value").then(snap => {
      document.getElementById("statPatients").textContent = snap.numChildren();
    });
    const today = new Date().toISOString().split('T')[0];
    db.ref("appointments").orderByChild("date").equalTo(today).once("value").then(snap => {
      document.getElementById("statAppointments").textContent = snap.numChildren();
    });
    db.ref("staff").once("value").then(snap => {
      let doctors = 0;
      snap.forEach(doc => {
        if (doc.val().role === "doctor") doctors++;
      });
      document.getElementById("statDoctors").textContent = doctors;
    });
  }

  // === –ú–∏–Ω. –¥–∞—Ç–∞ ===
  window.addEventListener("load", () => {
    const today = new Date().toISOString().split('T')[0];
    document.querySelectorAll('input[type="date"]').forEach(inp => {
      inp.setAttribute("min", today);
    });
  });
</script>
</body>
</html>
