<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ü–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞ ¬´–†–µ–Ω–µ—Å—Å–∞–Ω—Å¬ª ‚Äî –ê–¥–º–∏–Ω–∫–∞ —Å –≥—Ä–∞—Ñ–∏–∫–æ–º –Ω–∞ –≥–æ–¥</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    :root {
      --primary: #007bff;
      --success: #28a745;
      --warning: #ffc107;
      --danger: #dc3545;
      --light: #f8f9fa;
      --dark: #343a40;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f7fa;
      color: #333;
      line-height: 1.6;
      padding: 0;
      margin: 0;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
    }
    header {
      background-color: var(--primary);
      color: white;
      padding: 15px 20px;
      text-align: center;
      border-radius: 8px 8px 0 0;
      margin-bottom: 20px;
      position: relative;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    header h1 {
      font-size: 1.8rem;
      margin: 0;
    }
    header button {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      background-color: #ff6b6b;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }
    header button:hover {
      background-color: #ff5252;
    }
    .hidden {
      display: none !important;
    }
    .card {
      background-color: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 20px;
    }
    .tabs button {
      flex: 1;
      min-width: 120px;
      padding: 10px;
      background-color: #e9ecef;
      border: 1px solid #ced4da;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.2s;
    }
    .tabs button:hover {
      background-color: #dee2e6;
    }
    .tabs button.active {
      background-color: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    input,
    select,
    textarea,
    button {
      width: 100%;
      padding: 10px;
      margin: 6px 0;
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-size: 1rem;
    }
    button {
      background-color: var(--primary);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover {
      opacity: 0.9;
    }
    .btn-success {
      background-color: var(--success);
    }
    .btn-warning {
      background-color: var(--warning);
      color: var(--dark);
    }
    .btn-danger {
      background-color: var(--danger);
    }
    .result {
      background-color: #eef6ff;
      padding: 15px;
      border-radius: 6px;
      margin-top: 15px;
      white-space: pre-wrap;
    }
    .doctor-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }
    .doctor-card {
      border: 1px solid #e0e0e0;
      padding: 14px;
      border-radius: 8px;
      background-color: #fafafa;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .doctor-card h4 {
      margin: 0 0 8px 0;
      color: var(--dark);
    }
    .doctor-card p {
      margin: 4px 0;
      font-size: 0.95rem;
    }
    .ticket {
      border: 2px dashed var(--primary);
      padding: 20px;
      margin: 20px 0;
      background-color: #f9f9ff;
      text-align: center;
      border-radius: 8px;
    }
    .ticket h3 {
      color: var(--primary);
      margin-bottom: 12px;
    }
    .ticket p {
      margin: 6px 0;
    }
    .ticket-id {
      font-size: 0.85rem;
      color: #666;
      margin-top: 12px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }
    th,
    td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    th {
      background-color: #f8f9fa;
      font-weight: bold;
    }
    @media print {
      body * {
        visibility: hidden;
      }
      .ticket,
      .ticket * {
        visibility: visible;
      }
      .ticket {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        margin: 0;
        padding: 20px;
        box-sizing: border-box;
      }
      button {
        display: none !important;
      }
    }
    .footer-note {
      text-align: center;
      font-size: 0.85rem;
      color: #6c757d;
      margin-top: 30px;
    }
  </style>
</head>
<body>

<!-- –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ -->
<div id="loginScreen" class="container">
  <div class="card" style="max-width: 420px; margin: 100px auto;">
    <h2 style="text-align: center; margin-bottom: 20px; color: var(--dark);">üîê –í—Ö–æ–¥ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>
    <input type="text" id="login" placeholder="–õ–æ–≥–∏–Ω" value="dem" autocomplete="off" />
    <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" value="0506" autocomplete="off" />
    <button onclick="login()">–í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</button>
    <p style="font-size: 13px; color: #666; margin-top: 15px; text-align: center;">
      –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —É—á—ë—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:<br>
      <b>–õ–æ–≥–∏–Ω:</b> dem &nbsp; | &nbsp; <b>–ü–∞—Ä–æ–ª—å:</b> 0506
    </p>
  </div>
</div>

<!-- –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ -->
<div id="mainApp" class="container hidden">
  <header>
    <h1>üè• –ü–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞ ¬´–†–µ–Ω–µ—Å—Å–∞–Ω—Å¬ª ‚Äî –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å</h1>
    <button onclick="logout()">–í—ã–π—Ç–∏</button>
  </header>

  <div class="tabs">
    <button class="tab-btn active" data-tab="doctors">üë®‚Äç‚öïÔ∏è –í—Ä–∞—á–∏ –∏ –≥—Ä–∞—Ñ–∏–∫ (365 –¥–Ω–µ–π)</button>
    <button class="tab-btn" data-tab="register">‚ûï –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–∞—Ü–∏–µ–Ω—Ç–∞</button>
    <button class="tab-btn" data-tab="search">üîç –ü–æ–∏—Å–∫ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
    <button class="tab-btn" data-tab="appointment">üìÖ –ó–∞–ø–∏—Å—å –∫ –≤—Ä–∞—á—É</button>
    <button class="tab-btn" data-tab="medical">ü©∫ –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –∫–∞—Ä—Ç–∞</button>
    <button class="tab-btn" data-tab="tickets">üé´ –¢–∞–ª–æ–Ω—ã</button>
  </div>

  <!-- –í–†–ê–ß–ò –ò –ì–†–ê–§–ò–ö -->
  <div id="doctors" class="card tab-content active">
    <h3>–°–ø–∏—Å–æ–∫ –≤—Ä–∞—á–µ–π –∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –≥–æ–¥ –≤–ø–µ—Ä—ë–¥</h3>
    <p>–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ 365 –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã—Ö –¥–Ω–µ–π (—Ç–æ–ª—å–∫–æ –±—É–¥–Ω–∏–µ –¥–Ω–∏: –ø–Ω‚Äì–ø—Ç).</p>
    <div id="doctorsList">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –≤—Ä–∞—á–µ–π...</div>
  </div>

  <!-- –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø -->
  <div id="register" class="card tab-content hidden">
    <h3>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–∞—Ü–∏–µ–Ω—Ç–∞</h3>
    <input id="regFio" placeholder="–§–ò–û –ø–æ–ª–Ω–æ—Å—Ç—å—é (–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á)" />
    <input id="regBirth" type="date" />
    <select id="regGender">
      <option value="">–ü–æ–ª</option>
      <option value="–ú">–ú—É–∂—Å–∫–æ–π</option>
      <option value="–ñ">–ñ–µ–Ω—Å–∫–∏–π</option>
    </select>
    <input id="regPhone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω (+79991234567)" />
    <input id="regEmail" placeholder="Email (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" type="email" />
    <input id="regAddress" placeholder="–ê–¥—Ä–µ—Å –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è" />
    <input id="regPassport" placeholder="–ü–∞—Å–ø–æ—Ä—Ç (—Å–µ—Ä–∏—è –Ω–æ–º–µ—Ä, –Ω–∞–ø—Ä–∏–º–µ—Ä: 4507 123456)" />
    <input id="regSnils" placeholder="–°–ù–ò–õ–° (123-456-789 00)" />
    <input id="regInn" placeholder="–ò–ù–ù (12 —Ü–∏—Ñ—Ä)" />
    <button class="btn-success" onclick="registerPatient()">‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞</button>
  </div>

  <!-- –ü–û–ò–°–ö –ò –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï -->
  <div id="search" class="card tab-content hidden">
    <h3>–ü–æ–∏—Å–∫ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–∞—Ü–∏–µ–Ω—Ç–∞</h3>
    <input id="searchQuery" placeholder="–í–≤–µ–¥–∏—Ç–µ –§–ò–û, –ø–∞—Å–ø–æ—Ä—Ç, –°–ù–ò–õ–° –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω..." />
    <button onclick="searchPatient()">–ù–∞–π—Ç–∏ –ø–∞—Ü–∏–µ–Ω—Ç–∞</button>
    <div id="searchResult" class="result"></div>
    <div id="editForm" class="hidden">
      <h4 style="margin: 16px 0 10px;">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</h4>
      <input id="editKey" type="hidden" />
      <input id="editFio" placeholder="–§–ò–û" />
      <input id="editBirth" type="date" />
      <select id="editGender">
        <option value="">–ü–æ–ª</option>
        <option value="–ú">–ú—É–∂—Å–∫–æ–π</option>
        <option value="–ñ">–ñ–µ–Ω—Å–∫–∏–π</option>
      </select>
      <input id="editPhone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" />
      <input id="editEmail" placeholder="Email" />
      <input id="editAddress" placeholder="–ê–¥—Ä–µ—Å" />
      <input id="editPassport" placeholder="–ü–∞—Å–ø–æ—Ä—Ç" />
      <input id="editSnils" placeholder="–°–ù–ò–õ–°" />
      <input id="editInn" placeholder="–ò–ù–ù" />
      <button class="btn-success" onclick="savePatient()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
      <button class="btn-danger" onclick="cancelEdit()">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>

  <!-- –ó–ê–ü–ò–°–¨ –ö –í–†–ê–ß–£ -->
  <div id="appointment" class="card tab-content hidden">
    <h3>–ó–∞–ø–∏—Å—å –ø–∞—Ü–∏–µ–Ω—Ç–∞ –Ω–∞ –ø—Ä–∏—ë–º</h3>
    <input id="appPassport" placeholder="–ü–∞—Å–ø–æ—Ä—Ç –ø–∞—Ü–∏–µ–Ω—Ç–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" />
    <select id="appDoctor">
      <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–∞—á–∞ ‚Äî</option>
    </select>
    <input id="appDate" type="date" />
    <select id="appTime">
      <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è ‚Äî</option>
    </select>
    <button class="btn-success" onclick="bookAppointment()">üìÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
    <div id="appResult" class="result"></div>
  </div>

  <!-- –ú–ï–î–ò–¶–ò–ù–°–ö–ê–Ø –ö–ê–†–¢–ê -->
  <div id="medical" class="card tab-content hidden">
    <h3>–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –∫–∞—Ä—Ç–∞ –ø–∞—Ü–∏–µ–Ω—Ç–∞</h3>
    <input id="medPassport" placeholder="–ü–∞—Å–ø–æ—Ä—Ç –ø–∞—Ü–∏–µ–Ω—Ç–∞" />
    <button onclick="loadMedicalRecord()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –º–µ–¥–∫–∞—Ä—Ç—É</button>
    <div id="medicalData" class="result"></div>

    <h4 style="margin-top: 20px;">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –ø–æ—Å–µ—â–µ–Ω–∏–µ</h4>
    <textarea id="medDiagnosis" placeholder="–î–∏–∞–≥–Ω–æ–∑ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –û–†–í–ò, –∞—Ä—Ç–µ—Ä–∏–∞–ª—å–Ω–∞—è –≥–∏–ø–µ—Ä—Ç–µ–Ω–∑–∏—è)" rows="2"></textarea>
    <textarea id="medConclusion" placeholder="–ó–∞–∫–ª—é—á–µ–Ω–∏–µ –≤—Ä–∞—á–∞" rows="3"></textarea>
    <textarea id="medPrescription" placeholder="–ù–∞–∑–Ω–∞—á–µ–Ω–∏—è, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –∞–Ω–∞–ª–∏–∑—ã" rows="2"></textarea>
    <button class="btn-success" onclick="addMedicalVisit()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –≤ –º–µ–¥–∫–∞—Ä—Ç—É</button>
  </div>

  <!-- –¢–ê–õ–û–ù–´ -->
  <div id="tickets" class="card tab-content hidden">
    <h3>–ü–µ—á–∞—Ç—å —Ç–∞–ª–æ–Ω–∞ –Ω–∞ –ø—Ä–∏—ë–º</h3>
    <p>–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–ø–∏—Å–∏ —Ç–∞–ª–æ–Ω –ø–æ—è–≤–∏—Ç—Å—è –Ω–∏–∂–µ. –ù–∞–∂–º–∏—Ç–µ ¬´–†–∞—Å–ø–µ—á–∞—Ç–∞—Ç—å¬ª, —á—Ç–æ–±—ã —Ä–∞—Å–ø–µ—á–∞—Ç–∞—Ç—å –∏–ª–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ PDF.</p>
    <div id="ticketContainer"></div>
  </div>

  <div class="footer-note">
    –°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∏ ¬´–†–µ–Ω–µ—Å—Å–∞–Ω—Å¬ª ‚Äî –≤–µ—Ä—Å–∏—è 1.0 | –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã ¬© 2025
  </div>
</div>

<script>
  // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase ===
  const firebaseConfig = {
    databaseURL: "https://renessans-bank-3df94-default-rtdb.europe-west1.firebasedatabase.app/"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // === –§—É–Ω–∫—Ü–∏—è –≤—Ö–æ–¥–∞ ===
  function login() {
    const loginValue = document.getElementById("login").value.trim();
    const passwordValue = document.getElementById("password").value.trim();
    if (loginValue === "dem" && passwordValue === "0506") {
      document.getElementById("loginScreen").classList.add("hidden");
      document.getElementById("mainApp").classList.remove("hidden");
      initializeSystem();
    } else {
      alert("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.");
    }
  }

  // === –§—É–Ω–∫—Ü–∏—è –≤—ã—Ö–æ–¥–∞ ===
  function logout() {
    document.getElementById("mainApp").classList.add("hidden");
    document.getElementById("loginScreen").classList.remove("hidden");
  }

  // === –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫ ===
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll('.tab-btn').forEach(button => {
      button.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
        button.classList.add('active');
        const tabId = button.getAttribute('data-tab');
        document.getElementById(tabId).classList.remove('hidden');
      });
    });
  });

  // === –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –Ω–∞ 365 –¥–Ω–µ–π (—Ç–æ–ª—å–∫–æ –±—É–¥–Ω–∏) ===
  function generateFullYearSchedule() {
    const schedule = {};
    const today = new Date();
    const timeSlots = ["09:00", "10:00", "11:00", "12:00", "14:00", "15:00", "16:00"];
    for (let i = 0; i < 365; i++) {
      const currentDate = new Date(today);
      currentDate.setDate(today.getDate() + i);
      const dayOfWeek = currentDate.getDay();
      if (dayOfWeek === 0 || dayOfWeek === 6) continue; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ (0) –∏ —Å—É–±–±–æ—Ç—É (6)
      const dateKey = currentDate.toISOString().split('T')[0];
      schedule[dateKey] = [...timeSlots];
    }
    return schedule;
  }

  // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã: —Å–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–∞—á–µ–π –∏ –≥—Ä–∞—Ñ–∏–∫–∞ ===
  function initializeSystem() {
    db.ref("staff").once("value")
      .then(snapshot => {
        if (snapshot.exists()) {
          console.log("‚úÖ –í—Ä–∞—á–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.");
        } else {
          const fullYearSchedule = generateFullYearSchedule();
          const doctorsData = {
            doc1: {
              fio: "–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á",
              specialty: "–¢–µ—Ä–∞–ø–µ–≤—Ç",
              experience: "12 –ª–µ—Ç",
              schedule: fullYearSchedule
            },
            doc2: {
              fio: "–ü–µ—Ç—Ä–æ–≤–∞ –ê–Ω–Ω–∞ –°–µ—Ä–≥–µ–µ–≤–Ω–∞",
              specialty: "–û—Ñ—Ç–∞–ª—å–º–æ–ª–æ–≥",
              experience: "8 –ª–µ—Ç",
              schedule: fullYearSchedule
            },
            doc3: {
              fio: "–°–∏–¥–æ—Ä–æ–≤ –î–º–∏—Ç—Ä–∏–π –ê–ª–µ–∫—Å–µ–µ–≤–∏—á",
              specialty: "–•–∏—Ä—É—Ä–≥",
              experience: "15 –ª–µ—Ç",
              schedule: fullYearSchedule
            }
          };
          return db.ref("staff").set(doctorsData);
        }
      })
      .then(() => {
        console.log("‚úÖ –°–∏—Å—Ç–µ–º–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞: 3 –≤—Ä–∞—á–∞, –≥—Ä–∞—Ñ–∏–∫ –Ω–∞ 365 –¥–Ω–µ–π.");
        loadDoctorsList();
        loadDoctorsToAppointmentSelect();
      })
      .catch(error => {
        console.error("‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:", error);
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Firebase.");
      });
  }

  // === –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –≤—Ä–∞—á–µ–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è ===
  function loadDoctorsList() {
    const container = document.getElementById("doctorsList");
    container.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞...";

    db.ref("staff").once("value")
      .then(snapshot => {
        if (snapshot.exists()) {
          container.innerHTML = "";
          let doctorCount = 0;
          snapshot.forEach(childSnapshot => {
            const doctor = childSnapshot.val();
            const scheduleDates = Object.keys(doctor.schedule).sort();
            const nextThreeDates = scheduleDates.slice(0, 3).join(", ");
            const totalWorkDays = scheduleDates.length;

            const doctorCard = document.createElement("div");
            doctorCard.className = "doctor-card";
            doctorCard.innerHTML = `
              <h4>${doctor.fio}</h4>
              <p><strong>–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å:</strong> ${doctor.specialty}</p>
              <p><strong>–°—Ç–∞–∂:</strong> ${doctor.experience}</p>
              <p><strong>–ë–ª–∏–∂–∞–π—à–∏–µ –¥–∞—Ç—ã:</strong> ${nextThreeDates || "‚Äî"} </p>
              <p><strong>–í—Å–µ–≥–æ —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π –≤ –≥—Ä–∞—Ñ–∏–∫–µ:</strong> ${totalWorkDays}</p>
            `;
            container.appendChild(doctorCard);
            doctorCount++;
          });

          if (doctorCount === 0) {
            container.innerHTML = "<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –≤—Ä–∞—á–∞—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.</p>";
          }
        } else {
          container.innerHTML = "<p>–í—Ä–∞—á–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –°–∏—Å—Ç–µ–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã–ª–∞ —Å–æ–∑–¥–∞—Ç—å –∏—Ö –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</p>";
        }
      })
      .catch(error => {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Ä–∞—á–µ–π:", error);
        container.innerHTML = "<p>‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Ä–∞—á–µ–π.</p>";
      });
  }

  // === –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Ä–∞—á–µ–π –≤ –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –¥–ª—è –∑–∞–ø–∏—Å–∏ ===
  function loadDoctorsToAppointmentSelect() {
    const selectElement = document.getElementById("appDoctor");
    if (!selectElement) return;

    selectElement.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–∞—á–∞ ‚Äî</option>';
    db.ref("staff").once("value")
      .then(snapshot => {
        snapshot.forEach(childSnapshot => {
          const doctor = childSnapshot.val();
          const option = document.createElement("option");
          option.value = childSnapshot.key;
          option.textContent = `${doctor.fio} (${doctor.specialty})`;
          selectElement.appendChild(option);
        });
      });
  }

  // === –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–∞—Ü–∏–µ–Ω—Ç–∞ ===
  function registerPatient() {
    const fio = document.getElementById("regFio").value.trim();
    const birth = document.getElementById("regBirth").value;
    const gender = document.getElementById("regGender").value;
    const phone = document.getElementById("regPhone").value.trim();
    const email = document.getElementById("regEmail").value.trim();
    const address = document.getElementById("regAddress").value.trim();
    const passport = document.getElementById("regPassport").value.trim();
    const snils = document.getElementById("regSnils").value.trim();
    const inn = document.getElementById("regInn").value.trim();

    if (!fio || !passport || !birth) {
      alert("‚ùå –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: –§–ò–û, –ø–∞—Å–ø–æ—Ä—Ç, –¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è.");
      return;
    }

    const patientKey = passport.replace(/\s+/g, "_");
    const patientData = {
      fio, birth, gender, phone, email, address, passport, snils, inn,
      createdAt: new Date().toISOString()
    };

    db.ref("patients/" + patientKey).set(patientData)
      .then(() => {
        alert("‚úÖ –ü–∞—Ü–∏–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω!");
        document.querySelectorAll("#register input, #register select, #register textarea").forEach(el => el.value = "");
      })
      .catch(error => {
        console.error("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:", error);
        alert("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞.");
      });
  }

  // === –ü–æ–∏—Å–∫ –ø–∞—Ü–∏–µ–Ω—Ç–∞ ===
  function searchPatient() {
    const query = document.getElementById("searchQuery").value.trim().toLowerCase();
    if (!query) {
      alert("–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–∏—Å–∫–∞.");
      return;
    }

    db.ref("patients").once("value")
      .then(snapshot => {
        let foundPatient = null;
        snapshot.forEach(childSnapshot => {
          const patient = childSnapshot.val();
          const searchableFields = [
            patient.fio,
            patient.passport,
            patient.snils,
            patient.phone,
            patient.email,
            patient.address
          ];
          if (searchableFields.some(field => field && field.toLowerCase().includes(query))) {
            foundPatient = { key: childSnapshot.key, ...patient };
            return false;
          }
        });

        const resultDiv = document.getElementById("searchResult");
        const editForm = document.getElementById("editForm");
        if (foundPatient) {
          resultDiv.innerHTML = `
            <p><strong>–ù–∞–π–¥–µ–Ω –ø–∞—Ü–∏–µ–Ω—Ç:</strong> ${foundPatient.fio}</p>
            <p><strong>–ü–∞—Å–ø–æ—Ä—Ç:</strong> ${foundPatient.passport}</p>
            <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${foundPatient.phone || "‚Äî"}</p>
          `;
          populateEditForm(foundPatient);
          editForm.classList.remove("hidden");
        } else {
          resultDiv.innerHTML = "<p>‚ùå –ü–∞—Ü–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.</p>";
          editForm.classList.add("hidden");
        }
      });
  }

  // === –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ===
  function populateEditForm(patient) {
    document.getElementById("editKey").value = patient.key;
    document.getElementById("editFio").value = patient.fio || '';
    document.getElementById("editBirth").value = patient.birth || '';
    document.getElementById("editGender").value = patient.gender || '';
    document.getElementById("editPhone").value = patient.phone || '';
    document.getElementById("editEmail").value = patient.email || '';
    document.getElementById("editAddress").value = patient.address || '';
    document.getElementById("editPassport").value = patient.passport || '';
    document.getElementById("editSnils").value = patient.snils || '';
    document.getElementById("editInn").value = patient.inn || '';
  }

  // === –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–∞—Ü–∏–µ–Ω—Ç–∞ ===
  function savePatient() {
    const key = document.getElementById("editKey").value;
    if (!key) {
      alert("‚ùå –û—à–∏–±–∫–∞: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–∞—Ü–∏–µ–Ω—Ç–∞.");
      return;
    }

    const updatedData = {
      fio: document.getElementById("editFio").value.trim(),
      birth: document.getElementById("editBirth").value,
      gender: document.getElementById("editGender").value,
      phone: document.getElementById("editPhone").value.trim(),
      email: document.getElementById("editEmail").value.trim(),
      address: document.getElementById("editAddress").value.trim(),
      passport: document.getElementById("editPassport").value.trim(),
      snils: document.getElementById("editSnils").value.trim(),
      inn: document.getElementById("editInn").value.trim()
    };

    if (!updatedData.fio || !updatedData.passport) {
      alert("‚ùå –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: –§–ò–û –∏ –ø–∞—Å–ø–æ—Ä—Ç.");
      return;
    }

    db.ref("patients/" + key).update(updatedData)
      .then(() => {
        alert("‚úÖ –î–∞–Ω–Ω—ã–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!");
        document.getElementById("editForm").classList.add("hidden");
        document.getElementById("searchQuery").value = "";
        document.getElementById("searchResult").innerHTML = "<p>–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.</p>";
      })
      .catch(error => {
        console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:", error);
        alert("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è.");
      });
  }

  // === –û—Ç–º–µ–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ===
  function cancelEdit() {
    document.getElementById("editForm").classList.add("hidden");
  }

  // === –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –≤—Ä–∞—á–∞ –∏–ª–∏ –¥–∞—Ç—ã ===
  document.addEventListener("DOMContentLoaded", () => {
    const doctorSelect = document.getElementById("appDoctor");
    const dateInput = document.getElementById("appDate");
    if (doctorSelect && dateInput) {
      doctorSelect.addEventListener("change", updateAvailableTimes);
      dateInput.addEventListener("change", updateAvailableTimes);
    }
  });

  function updateAvailableTimes() {
    const doctorId = document.getElementById("appDoctor")?.value;
    const selectedDate = document.getElementById("appDate")?.value;
    const timeSelect = document.getElementById("appTime");
    if (!doctorId || !selectedDate || !timeSelect) return;

    timeSelect.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è ‚Äî</option>';

    db.ref(`staff/${doctorId}/schedule/${selectedDate}`).once("value")
      .then(scheduleSnapshot => {
        const allSlots = scheduleSnapshot.val() || [];
        return db.ref("appointments")
          .orderByChild("doctorDate")
          .equalTo(`${doctorId}_${selectedDate}`)
          .once("value")
          .then(appointmentsSnapshot => {
            const busyTimes = {};
            appointmentsSnapshot.forEach(appointment => {
              const appointmentData = appointment.val();
              busyTimes[appointmentData.time] = true;
            });
            return { allSlots, busyTimes };
          });
      })
      .then(({ allSlots, busyTimes }) => {
        allSlots.forEach(timeSlot => {
          if (!busyTimes[timeSlot]) {
            const option = document.createElement("option");
            option.value = timeSlot;
            option.textContent = timeSlot;
            timeSelect.appendChild(option);
          }
        });
      })
      .catch(error => {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Ä–µ–º–µ–Ω–∏:", error);
      });
  }

  // === –ó–∞–ø–∏—Å—å –∫ –≤—Ä–∞—á—É ===
  function bookAppointment() {
    const passport = document.getElementById("appPassport")?.value.trim();
    const doctorId = document.getElementById("appDoctor")?.value;
    const appointmentDate = document.getElementById("appDate")?.value;
    const appointmentTime = document.getElementById("appTime")?.value;

    if (!passport || !doctorId || !appointmentDate || !appointmentTime) {
      alert("‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è.");
      return;
    }

    const appointmentKey = `${appointmentDate}_${doctorId}_${appointmentTime}`;
    const ticketId = "T" + Date.now().toString(36).toUpperCase();

    const appointmentData = {
      patientPassport: passport,
      doctorId: doctorId,
      date: appointmentDate,
      time: appointmentTime,
      ticketId: ticketId,
      doctorDate: `${doctorId}_${appointmentDate}`,
      status: "confirmed",
      createdAt: new Date().toISOString()
    };

    db.ref("appointments/" + appointmentKey).set(appointmentData)
      .then(() => {
        document.getElementById("appResult").innerHTML = "‚úÖ –ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!";
        generateAndShowTicket(passport, doctorId, appointmentDate, appointmentTime, ticketId);
        updateAvailableTimes();
      })
      .catch(error => {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏:", error);
        alert("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å.");
      });
  }

  // === –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–∞–ª–æ–Ω–∞ ===
  function generateAndShowTicket(passport, doctorId, date, time, ticketId) {
    Promise.all([
      db.ref("patients/" + passport.replace(/\s+/g, "_")).once("value"),
      db.ref("staff/" + doctorId).once("value")
    ])
    .then(([patientSnapshot, doctorSnapshot]) => {
      const patient = patientSnapshot.val();
      const doctor = doctorSnapshot.val();

      const ticketHTML = `
        <div class="ticket" id="printableTicket">
          <h3>–¢–∞–ª–æ–Ω –Ω–∞ –ø—Ä–∏—ë–º –≤ –ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫—É ¬´–†–µ–Ω–µ—Å—Å–∞–Ω—Å¬ª</h3>
          <p><strong>–ü–∞—Ü–∏–µ–Ω—Ç:</strong> ${patient?.fio || "‚Äî"}</p>
          <p><strong>–í—Ä–∞—á:</strong> ${doctor?.fio || "‚Äî"} (${doctor?.specialty || "‚Äî"})</p>
          <p><strong>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è:</strong> ${date} –≤ ${time}</p>
          <p><strong>–ö–∞–±–∏–Ω–µ—Ç:</strong> 305</p>
          <p class="ticket-id">–£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Ç–∞–ª–æ–Ω–∞: ${ticketId}</p>
          <p style="margin-top: 15px; font-size: 0.9rem; color: #555;">
            –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–∏—Ö–æ–¥–∏—Ç–µ –∑–∞ 10 –º–∏–Ω—É—Ç –¥–æ –Ω–∞—á–∞–ª–∞ –ø—Ä–∏—ë–º–∞.<br>
            –ü—Ä–∏ —Å–µ–±–µ –∏–º–µ—Ç—å –ø–∞—Å–ø–æ—Ä—Ç –∏ –°–ù–ò–õ–°.
          </p>
        </div>
        <button onclick="window.print()" style="margin-top: 15px;">üñ®Ô∏è –†–∞—Å–ø–µ—á–∞—Ç–∞—Ç—å —Ç–∞–ª–æ–Ω</button>
      `;
      document.getElementById("ticketContainer").innerHTML = ticketHTML;
      document.querySelector('.tab-btn[data-tab="tickets"]').click();
    })
    .catch(error => {
      console.error("–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–∞–ª–æ–Ω–∞:", error);
    });
  }

  // === –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–π –∫–∞—Ä—Ç—ã ===
  function loadMedicalRecord() {
    const passport = document.getElementById("medPassport")?.value.trim();
    if (!passport) {
      alert("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Å–ø–æ—Ä—Ç –ø–∞—Ü–∏–µ–Ω—Ç–∞.");
      return;
    }

    const recordKey = passport.replace(/\s+/g, "_");
    db.ref("medicalRecords/" + recordKey).once("value")
      .then(snapshot => {
        const recordData = snapshot.val();
        const medicalDataDiv = document.getElementById("medicalData");
        if (!recordData || !recordData.visits || recordData.visits.length === 0) {
          medicalDataDiv.innerHTML = "<p>–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –∫–∞—Ä—Ç–∞ –ø—É—Å—Ç–∞.</p>";
          return;
        }

        const visits = recordData.visits.sort((a, b) => b.timestamp - a.timestamp);
        let html = "<h4>–ò—Å—Ç–æ—Ä–∏—è –ø–æ—Å–µ—â–µ–Ω–∏–π:</h4>";
        visits.forEach(visit => {
          html += `
            <div style="padding: 10px; border-left: 3px solid var(--primary); margin: 10px 0;">
              <p><strong>–î–∞—Ç–∞:</strong> ${visit.date}</p>
              <p><strong>–î–∏–∞–≥–Ω–æ–∑:</strong> ${visit.diagnosis || "‚Äî"}</p>
              <p><strong>–ó–∞–∫–ª—é—á–µ–Ω–∏–µ:</strong> ${visit.conclusion || "‚Äî"}</p>
              <p><strong>–ù–∞–∑–Ω–∞—á–µ–Ω–∏—è:</strong> ${visit.prescription || "‚Äî"}</p>
              <p><em>–í—Ä–∞—á: ${visit.doctor || "‚Äî"}</em></p>
            </div>
            <hr style="margin: 15px 0;">
          `;
        });
        medicalDataDiv.innerHTML = html;
      })
      .catch(error => {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–¥–∫–∞—Ä—Ç—ã:", error);
        document.getElementById("medicalData").innerHTML = "<p>‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–µ–¥–∫–∞—Ä—Ç—É.</p>";
      });
  }

  // === –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ –º–µ–¥–∫–∞—Ä—Ç—É ===
  function addMedicalVisit() {
    const passport = document.getElementById("medPassport")?.value.trim();
    const diagnosis = document.getElementById("medDiagnosis")?.value.trim();
    const conclusion = document.getElementById("medConclusion")?.value.trim();
    const prescription = document.getElementById("medPrescription")?.value.trim();

    if (!passport) {
      alert("–£–∫–∞–∂–∏—Ç–µ –ø–∞—Å–ø–æ—Ä—Ç –ø–∞—Ü–∏–µ–Ω—Ç–∞.");
      return;
    }

    const recordKey = passport.replace(/\s+/g, "_");
    const newVisit = {
      date: new Date().toISOString().split('T')[0],
      diagnosis: diagnosis,
      conclusion: conclusion,
      prescription: prescription,
      doctor: "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–∏—Å—Ç–µ–º—ã",
      timestamp: Date.now()
    };

    db.ref("medicalRecords/" + recordKey).transaction(currentData => {
      if (!currentData) currentData = { visits: [] };
      if (!currentData.visits) currentData.visits = [];
      currentData.visits.push(newVisit);
      return currentData;
    })
    .then(() => {
      alert("‚úÖ –ó–∞–ø–∏—Å—å –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –º–µ–¥–∏—Ü–∏–Ω—Å–∫—É—é –∫–∞—Ä—Ç—É.");
      loadMedicalRecord();
      document.getElementById("medDiagnosis").value = "";
      document.getElementById("medConclusion").value = "";
      document.getElementById("medPrescription").value = "";
    })
    .catch(error => {
      console.error("–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –º–µ–¥–∫–∞—Ä—Ç—É:", error);
      alert("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å.");
    });
  }

  // === –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –¥–∞—Ç—ã –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π ===
  window.addEventListener("load", () => {
    const today = new Date().toISOString().split('T')[0];
    const dateInputs = document.querySelectorAll('input[type="date"]');
    dateInputs.forEach(input => {
      input.setAttribute("min", today);
    });
  });
</script>
</body>
</html>
