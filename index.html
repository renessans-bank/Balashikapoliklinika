<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ü–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞ ¬´–†–µ–Ω–µ—Å—Å–∞–Ω—Å¬ª ‚Äî –ê–¥–º–∏–Ω–∫–∞</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    :root {
      --primary: #007bff;
      --success: #28a745;
      --warning: #ffc107;
      --danger: #dc3545;
      --light: #f8f9fa;
      --dark: #343a40;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f7fa;
      color: #333;
      line-height: 1.6;
    }
    .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
    header {
      background: var(--primary);
      color: white;
      padding: 15px;
      text-align: center;
      border-radius: 8px 8px 0 0;
      margin-bottom: 20px;
      position: relative;
    }
    header button {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      background: #ff6b6b;
      border: none;
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
    }
    .hidden { display: none !important; }
    .card {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 20px;
    }
    .tabs button {
      flex: 1;
      min-width: 120px;
      padding: 10px;
      background: #e9ecef;
      border: 1px solid #ddd;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    .tabs button.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    input, select, textarea, button {
      width: 100%;
      padding: 10px;
      margin: 6px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      background: var(--primary);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover { opacity: 0.9; }
    .btn-success { background: var(--success); }
    .btn-danger { background: var(--danger); }
    .btn-warning { background: var(--warning); color: var(--dark); }
    .result {
      background: #eef6ff;
      padding: 15px;
      border-radius: 6px;
      margin-top: 15px;
      white-space: pre-wrap;
    }
    .ticket {
      border: 2px dashed #007bff;
      padding: 20px;
      margin: 20px 0;
      background: #f9f9ff;
      text-align: center;
    }
    .ticket h2 { color: var(--primary); }
    .ticket p { margin: 8px 0; }
    .ticket-id { font-size: 12px; color: #666; margin-top: 15px; }
    .doctor-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    .doctor-card {
      border: 1px solid #eee;
      padding: 12px;
      border-radius: 6px;
      background: #fafafa;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
    @media print {
      body * { visibility: hidden; }
      .ticket, .ticket * { visibility: visible; }
      .ticket { position: absolute; left: 0; top: 0; width: 100%; }
      button { display: none !important; }
    }
  </style>
</head>
<body>

<!-- –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ -->
<div id="loginScreen" class="container">
  <div class="card" style="max-width:400px; margin:100px auto;">
    <h2 style="text-align:center; margin-bottom:20px;">üîê –í—Ö–æ–¥ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>
    <input type="text" id="login" placeholder="–õ–æ–≥–∏–Ω" value="dem" autocomplete="off" />
    <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" value="0506" autocomplete="off" />
    <button onclick="login()">–í–æ–π—Ç–∏</button>
    <p style="font-size:12px; color:#666; margin-top:15px; text-align:center;">
      –õ–æ–≥–∏–Ω: <b>dem</b> | –ü–∞—Ä–æ–ª—å: <b>0506</b>
    </p>
  </div>
</div>

<!-- –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ -->
<div id="mainApp" class="container hidden">
  <header>
    <h1>üè• –ü–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞ ¬´–†–µ–Ω–µ—Å—Å–∞–Ω—Å¬ª</h1>
    <button onclick="logout()">–í—ã–π—Ç–∏</button>
  </header>

  <div class="tabs">
    <button class="tab-btn active" data-tab="register">‚ûï –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
    <button class="tab-btn" data-tab="search">üîç –ü–æ–∏—Å–∫ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
    <button class="tab-btn" data-tab="appointment">üìÖ –ó–∞–ø–∏—Å—å –∫ –≤—Ä–∞—á—É</button>
    <button class="tab-btn" data-tab="medical">ü©∫ –ú–µ–¥–∫–∞—Ä—Ç–∞</button>
    <button class="tab-btn" data-tab="doctors">üë®‚Äç‚öïÔ∏è –í—Ä–∞—á–∏</button>
    <button class="tab-btn" data-tab="tickets">üé´ –¢–∞–ª–æ–Ω—ã</button>
  </div>

  <!-- –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø -->
  <div id="register" class="card tab-content active">
    <h3>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–∞—Ü–∏–µ–Ω—Ç–∞</h3>
    <input id="regFio" placeholder="–§–ò–û –ø–æ–ª–Ω–æ—Å—Ç—å—é (–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á)" />
    <input id="regBirth" type="date" />
    <select id="regGender"><option value="">–ü–æ–ª</option><option value="–ú">–ú—É–∂—Å–∫–æ–π</option><option value="–ñ">–ñ–µ–Ω—Å–∫–∏–π</option></select>
    <input id="regPhone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω (+79991234567)" />
    <input id="regEmail" placeholder="Email (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" type="email" />
    <input id="regAddress" placeholder="–ê–¥—Ä–µ—Å –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è" />
    <input id="regPassport" placeholder="–ü–∞—Å–ø–æ—Ä—Ç (—Å–µ—Ä–∏—è –Ω–æ–º–µ—Ä, –Ω–∞–ø—Ä–∏–º–µ—Ä: 4507 123456)" />
    <input id="regSnils" placeholder="–°–ù–ò–õ–° (123-456-789 00)" />
    <input id="regInn" placeholder="–ò–ù–ù (12 —Ü–∏—Ñ—Ä)" />
    <button class="btn-success" onclick="registerPatient()">‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
  </div>

  <!-- –ü–û–ò–°–ö –ò –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï -->
  <div id="search" class="card tab-content hidden">
    <h3>–ü–æ–∏—Å–∫ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞</h3>
    <input id="searchQuery" placeholder="–§–ò–û, –ø–∞—Å–ø–æ—Ä—Ç, –°–ù–ò–õ–°, —Ç–µ–ª–µ—Ñ–æ–Ω..." />
    <button onclick="searchPatient()">–ù–∞–π—Ç–∏</button>
    <div id="searchResult" class="result"></div>
    <div id="editForm" class="hidden">
      <h4 style="margin:15px 0 10px;">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h4>
      <input id="editKey" type="hidden" />
      <input id="editFio" placeholder="–§–ò–û" />
      <input id="editBirth" type="date" />
      <select id="editGender"><option value="">–ü–æ–ª</option><option value="–ú">–ú—É–∂—Å–∫–æ–π</option><option value="–ñ">–ñ–µ–Ω—Å–∫–∏–π</option></select>
      <input id="editPhone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" />
      <input id="editEmail" placeholder="Email" />
      <input id="editAddress" placeholder="–ê–¥—Ä–µ—Å" />
      <input id="editPassport" placeholder="–ü–∞—Å–ø–æ—Ä—Ç" />
      <input id="editSnils" placeholder="–°–ù–ò–õ–°" />
      <input id="editInn" placeholder="–ò–ù–ù" />
      <button class="btn-success" onclick="savePatient()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button class="btn-danger" onclick="cancelEdit()">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>

  <!-- –ó–ê–ü–ò–°–¨ -->
  <div id="appointment" class="card tab-content hidden">
    <h3>–ó–∞–ø–∏—Å—å –∫ –≤—Ä–∞—á—É</h3>
    <input id="appPassport" placeholder="–ü–∞—Å–ø–æ—Ä—Ç –ø–∞—Ü–∏–µ–Ω—Ç–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" />
    <select id="appDoctor"><option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–∞—á–∞ ‚Äî</option></select>
    <input id="appDate" type="date" />
    <select id="appTime"><option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è ‚Äî</option></select>
    <button class="btn-success" onclick="bookAppointment()">üìÖ –ó–∞–ø–∏—Å–∞—Ç—å</button>
    <div id="appResult" class="result"></div>
  </div>

  <!-- –ú–ï–î–ö–ê–†–¢–ê -->
  <div id="medical" class="card tab-content hidden">
    <h3>–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –∫–∞—Ä—Ç–∞</h3>
    <input id="medPassport" placeholder="–ü–∞—Å–ø–æ—Ä—Ç –ø–∞—Ü–∏–µ–Ω—Ç–∞" />
    <button onclick="loadMedicalRecord()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç—É</button>
    <div id="medicalData" class="result"></div>

    <h4 style="margin-top:20px;">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –ø–æ—Å–µ—â–µ–Ω–∏–µ</h4>
    <textarea id="medDiagnosis" placeholder="–î–∏–∞–≥–Ω–æ–∑ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –û–†–í–ò, –≥–∏–ø–µ—Ä—Ç–æ–Ω–∏—è)" rows="2"></textarea>
    <textarea id="medConclusion" placeholder="–ó–∞–∫–ª—é—á–µ–Ω–∏–µ –≤—Ä–∞—á–∞" rows="3"></textarea>
    <textarea id="medPrescription" placeholder="–ù–∞–∑–Ω–∞—á–µ–Ω–∏—è / –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏" rows="2"></textarea>
    <button class="btn-success" onclick="addMedicalVisit()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
  </div>

  <!-- –í–†–ê–ß–ò -->
  <div id="doctors" class="card tab-content hidden">
    <h3>–°–ø–∏—Å–æ–∫ –≤—Ä–∞—á–µ–π</h3>
    <div class="doctor-grid" id="doctorsList">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  </div>

  <!-- –¢–ê–õ–û–ù–´ -->
  <div id="tickets" class="card tab-content hidden">
    <h3>–ü–µ—á–∞—Ç—å —Ç–∞–ª–æ–Ω–∞</h3>
    <p>–ü–æ—Å–ª–µ –∑–∞–ø–∏—Å–∏ –∫ –≤—Ä–∞—á—É —Ç–∞–ª–æ–Ω –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</p>
    <div id="ticketContainer"></div>
  </div>
</div>

<script>
  // === Firebase ===
  const firebaseConfig = {
    databaseURL: "https://renessans-bank-3df94-default-rtdb.europe-west1.firebasedatabase.app/"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // === –í—Ö–æ–¥ / –í—ã—Ö–æ–¥ ===
  function login() {
    const l = document.getElementById("login").value.trim();
    const p = document.getElementById("password").value.trim();
    if (l === "dem" && p === "0506") {
      document.getElementById("loginScreen").classList.add("hidden");
      document.getElementById("mainApp").classList.remove("hidden");
      loadDoctors();
      initStaff();
    } else {
      alert("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å");
    }
  }
  function logout() {
    document.getElementById("mainApp").classList.add("hidden");
    document.getElementById("loginScreen").classList.remove("hidden");
  }

  // === –í–∫–ª–∞–¥–∫–∏ ===
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
      btn.classList.add('active');
      document.getElementById(btn.dataset.tab).classList.remove('hidden');
    });
  });

  // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Ä–∞—á–µ–π ===
  function initStaff() {
    db.ref("staff").once("value", snap => {
      if (snap.exists()) return;
      const today = new Date();
      const schedule = {};
      for (let i = 0; i < 14; i++) {
        const d = new Date(today);
        d.setDate(d.getDate() + i);
        const dateStr = d.toISOString().split('T')[0];
        schedule[dateStr] = ["09:00", "10:00", "11:00", "12:00", "14:00", "15:00", "16:00"];
      }
      db.ref("staff").set({
        doc1: { fio: "–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á", specialty: "–¢–µ—Ä–∞–ø–µ–≤—Ç", experience: "12 –ª–µ—Ç", schedule },
        doc2: { fio: "–ü–µ—Ç—Ä–æ–≤–∞ –ê–Ω–Ω–∞ –°–µ—Ä–≥–µ–µ–≤–Ω–∞", specialty: "–û—Ñ—Ç–∞–ª—å–º–æ–ª–æ–≥", experience: "8 –ª–µ—Ç", schedule },
        doc3: { fio: "–°–∏–¥–æ—Ä–æ–≤ –î–º–∏—Ç—Ä–∏–π –ê–ª–µ–∫—Å–µ–µ–≤–∏—á", specialty: "–•–∏—Ä—É—Ä–≥", experience: "15 –ª–µ—Ç", schedule }
      });
    });
  }

  // === –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Ä–∞—á–µ–π –≤ —Å–µ–ª–µ–∫—Ç –∏ —Å–ø–∏—Å–æ–∫ ===
  function loadDoctors() {
    const sel = document.getElementById("appDoctor");
    sel.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–∞—á–∞ ‚Äî</option>';
    const list = document.getElementById("doctorsList");
    list.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞...";

    db.ref("staff").once("value", snap => {
      list.innerHTML = "";
      snap.forEach(doc => {
        const d = doc.val();
        const opt = document.createElement("option");
        opt.value = doc.key;
        opt.textContent = `${d.fio} (${d.specialty})`;
        sel.appendChild(opt);

        const card = document.createElement("div");
        card.className = "doctor-card";
        card.innerHTML = `<b>${d.fio}</b><br><i>${d.specialty}</i><br>–°—Ç–∞–∂: ${d.experience}`;
        list.appendChild(card);
      });
    });
  }

  // === –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–∞—Ü–∏–µ–Ω—Ç–∞ ===
  function registerPatient() {
    const fio = document.getElementById("regFio").value.trim();
    const birth = document.getElementById("regBirth").value;
    const gender = document.getElementById("regGender").value;
    const phone = document.getElementById("regPhone").value.trim();
    const email = document.getElementById("regEmail").value.trim();
    const address = document.getElementById("regAddress").value.trim();
    const passport = document.getElementById("regPassport").value.trim();
    const snils = document.getElementById("regSnils").value.trim();
    const inn = document.getElementById("regInn").value.trim();

    if (!fio || !passport || !birth) {
      alert("‚ùå –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ: –§–ò–û, –ø–∞—Å–ø–æ—Ä—Ç, –¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è");
      return;
    }

    const key = passport.replace(/\s+/g, "_");
    db.ref("patients/" + key).set({
      fio, birth, gender, phone, email, address, passport, snils, inn,
      createdAt: new Date().toISOString()
    }).then(() => {
      alert("‚úÖ –ü–∞—Ü–∏–µ–Ω—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω!");
      document.querySelectorAll("#register input").forEach(el => el.value = "");
    });
  }

  // === –ü–æ–∏—Å–∫ –ø–∞—Ü–∏–µ–Ω—Ç–∞ ===
  function searchPatient() {
    const q = document.getElementById("searchQuery").value.trim().toLowerCase();
    if (!q) return;

    db.ref("patients").once("value", snap => {
      let found = null;
      snap.forEach(p => {
        const pat = p.val();
        const fields = [pat.fio, pat.passport, pat.snils, pat.phone, pat.email, pat.address];
        if (fields.some(f => f && f.toLowerCase().includes(q))) {
          found = { key: p.key, ...pat };
          return false; // break
        }
      });

      const res = document.getElementById("searchResult");
      const edit = document.getElementById("editForm");
      if (found) {
        res.innerHTML = `<p><b>${found.fio}</b><br>–ü–∞—Å–ø–æ—Ä—Ç: ${found.passport}<br>–¢–µ–ª–µ—Ñ–æ–Ω: ${found.phone || '‚Äî'}</p>`;
        document.getElementById("editKey").value = found.key;
        document.getElementById("editFio").value = found.fio || '';
        document.getElementById("editBirth").value = found.birth || '';
        document.getElementById("editGender").value = found.gender || '';
        document.getElementById("editPhone").value = found.phone || '';
        document.getElementById("editEmail").value = found.email || '';
        document.getElementById("editAddress").value = found.address || '';
        document.getElementById("editPassport").value = found.passport || '';
        document.getElementById("editSnils").value = found.snils || '';
        document.getElementById("editInn").value = found.inn || '';
        edit.classList.remove("hidden");
      } else {
        res.innerHTML = "‚ùå –ü–∞—Ü–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω";
        edit.classList.add("hidden");
      }
    });
  }

  // === –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π ===
  function savePatient() {
    const key = document.getElementById("editKey").value;
    if (!key) return alert("‚ùå –û—à–∏–±–∫–∞ –∫–ª—é—á–∞");

    const data = {
      fio: document.getElementById("editFio").value.trim(),
      birth: document.getElementById("editBirth").value,
      gender: document.getElementById("editGender").value,
      phone: document.getElementById("editPhone").value.trim(),
      email: document.getElementById("editEmail").value.trim(),
      address: document.getElementById("editAddress").value.trim(),
      passport: document.getElementById("editPassport").value.trim(),
      snils: document.getElementById("editSnils").value.trim(),
      inn: document.getElementById("editInn").value.trim()
    };

    if (!data.fio || !data.passport) return alert("‚ùå –§–ò–û –∏ –ø–∞—Å–ø–æ—Ä—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã");

    db.ref("patients/" + key).update(data).then(() => {
      alert("‚úÖ –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!");
      document.getElementById("editForm").classList.add("hidden");
      document.getElementById("searchQuery").value = "";
      document.getElementById("searchResult").innerHTML = "<p>–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.</p>";
    });
  }

  function cancelEdit() {
    document.getElementById("editForm").classList.add("hidden");
  }

  // === –ó–∞–ø–∏—Å—å –∫ –≤—Ä–∞—á—É ===
  document.getElementById("appDoctor").addEventListener("change", updateAvailableTimes);
  document.getElementById("appDate").addEventListener("change", updateAvailableTimes);

  function updateAvailableTimes() {
    const docId = document.getElementById("appDoctor").value;
    const date = document.getElementById("appDate").value;
    const sel = document.getElementById("appTime");
    sel.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è ‚Äî</option>';
    if (!docId || !date) return;

    db.ref(`staff/${docId}/schedule/${date}`).once("value", scheduleSnap => {
      const all = scheduleSnap.val() || [];
      db.ref("appointments").orderByChild("doctorDate").equalTo(`${docId}_${date}`).once("value", appts => {
        const busy = {};
        appts.forEach(a => { busy[a.val().time] = true; });
        all.filter(t => !busy[t]).forEach(t => {
          const opt = document.createElement("option");
          opt.value = t;
          opt.textContent = t;
          sel.appendChild(opt);
        });
      });
    });
  }

  function bookAppointment() {
    const passport = document.getElementById("appPassport").value.trim();
    const docId = document.getElementById("appDoctor").value;
    const date = document.getElementById("appDate").value;
    const time = document.getElementById("appTime").value;

    if (!passport || !docId || !date || !time) {
      alert("‚ùå –í—Å–µ –ø–æ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã");
      return;
    }

    const key = `${date}_${docId}_${time}`;
    const ticketId = "T" + Date.now().toString(36).toUpperCase();

    db.ref("appointments/" + key).set({
      patientPassport: passport,
      doctorId: docId,
      date, time,
      ticketId,
      doctorDate: `${docId}_${date}`,
      status: "confirmed",
      createdAt: new Date().toISOString()
    }).then(() => {
      document.getElementById("appResult").innerHTML = "‚úÖ –ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞!";
      showTicket(passport, docId, date, time, ticketId);
      updateAvailableTimes();
    });
  }

  // === –¢–∞–ª–æ–Ω ===
  function showTicket(passport, doctorId, date, time, ticketId) {
    Promise.all([
      db.ref("patients/" + passport.replace(/\s+/g, "_")).once("value"),
      db.ref("staff/" + doctorId).once("value")
    ]).then(([patSnap, docSnap]) => {
      const pat = patSnap.val();
      const doc = docSnap.val();

      const html = `
        <div class="ticket" id="ticketPrint">
          <div class="ticket-header">
            <h2>–ü–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞ ¬´–†–µ–Ω–µ—Å—Å–∞–Ω—Å¬ª</h2>
            <p>–¢–∞–ª–æ–Ω –Ω–∞ –ø—Ä–∏—ë–º</p>
          </div>
          <div class="ticket-body">
            <p><b>–ü–∞—Ü–∏–µ–Ω—Ç:</b> ${pat?.fio || '‚Äî'}</p>
            <p><b>–í—Ä–∞—á:</b> ${doc?.fio || '‚Äî'} (${doc?.specialty || '‚Äî'})</p>
            <p><b>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è:</b> ${date} –≤ ${time}</p>
            <p><b>–ö–∞–±–∏–Ω–µ—Ç:</b> 305</p>
            <p class="ticket-id">ID —Ç–∞–ª–æ–Ω–∞: ${ticketId}</p>
          </div>
          <div class="ticket-footer">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–∏—Ö–æ–¥–∏—Ç–µ –∑–∞ 10 –º–∏–Ω—É—Ç –¥–æ –ø—Ä–∏—ë–º–∞.</div>
        </div>
        <button onclick="window.print()">üñ®Ô∏è –†–∞—Å–ø–µ—á–∞—Ç–∞—Ç—å —Ç–∞–ª–æ–Ω</button>
      `;
      document.getElementById("ticketContainer").innerHTML = html;
      document.querySelector('.tab-btn[data-tab="tickets"]').click();
    });
  }

  // === –ú–µ–¥–∫–∞—Ä—Ç–∞ ===
  function loadMedicalRecord() {
    const passport = document.getElementById("medPassport").value.trim();
    if (!passport) return;
    const key = passport.replace(/\s+/g, "_");
    db.ref("medicalRecords/" + key).once("value", snap => {
      const data = snap.val();
      const div = document.getElementById("medicalData");
      if (!data || !data.visits || data.visits.length === 0) {
        div.innerHTML = "<p>–ú–µ–¥–∫–∞—Ä—Ç–∞ –ø—É—Å—Ç–∞.</p>";
        return;
      }
      div.innerHTML = data.visits.reverse().map(v => 
        `<p><b>${v.date}</b><br>ü©∫ –î–∏–∞–≥–Ω–æ–∑: ${v.diagnosis || '‚Äî'}<br>üìù –ó–∞–∫–ª—é—á–µ–Ω–∏–µ: ${v.conclusion || '‚Äî'}<br>üíä –ù–∞–∑–Ω–∞—á–µ–Ω–∏—è: ${v.prescription || '‚Äî'}</p><hr>`
      ).join("");
    });
  }

  function addMedicalVisit() {
    const passport = document.getElementById("medPassport").value.trim();
    const diagnosis = document.getElementById("medDiagnosis").value.trim();
    const conclusion = document.getElementById("medConclusion").value.trim();
    const prescription = document.getElementById("medPrescription").value.trim();

    if (!passport) return alert("–£–∫–∞–∂–∏—Ç–µ –ø–∞—Å–ø–æ—Ä—Ç");
    const key = passport.replace(/\s+/g, "_");
    const newVisit = {
      date: new Date().toISOString().split('T')[0],
      diagnosis,
      conclusion,
      prescription,
      doctor: "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä",
      timestamp: Date.now()
    };

    db.ref("medicalRecords/" + key).transaction(record => {
      if (!record) record = { visits: [] };
      record.visits.push(newVisit);
      return record;
    }).then(() => {
      alert("‚úÖ –ó–∞–ø–∏—Å—å –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –º–µ–¥–∫–∞—Ä—Ç—É");
      loadMedicalRecord();
      ["medDiagnosis", "medConclusion", "medPrescription"].forEach(id => {
        document.getElementById(id).value = "";
      });
    });
  }

  // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ===
  window.addEventListener('load', () => {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById("appDate")?.setAttribute("min", today);
    document.getElementById("regBirth")?.setAttribute("max", today);
  });
</script>
</body>
</html>
