<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ü–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞ ¬´–†–µ–Ω–µ—Å—Å–∞–Ω—Å¬ª ‚Äî –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è (1200+ —Å—Ç—Ä–æ–∫)</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    :root {
      --primary: #007bff;
      --success: #28a745;
      --danger: #dc3545;
      --warning: #ffc107;
      --light: #f8f9fa;
      --dark: #343a40;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f7fa;
      color: #333;
      line-height: 1.6;
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 20px;
    }
    header {
      background-color: var(--primary);
      color: white;
      padding: 16px 20px;
      text-align: center;
      border-radius: 8px 8px 0 0;
      margin-bottom: 22px;
      position: relative;
      box-shadow: 0 3px 8px rgba(0,0,0,0.12);
    }
    header h1 {
      font-size: 1.9rem;
      margin: 0;
    }
    header button {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      background-color: #ff6b6b;
      color: white;
      border: none;
      padding: 7px 14px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    header button:hover {
      background-color: #ff5252;
    }
    .hidden {
      display: none !important;
    }
    .card {
      background-color: white;
      padding: 22px;
      margin-bottom: 22px;
      border-radius: 10px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.09);
    }
    .tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 22px;
    }
    .tabs button {
      flex: 1;
      min-width: 130px;
      padding: 11px;
      background-color: #e9ecef;
      border: 1px solid #ced4da;
      border-radius: 7px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.25s;
    }
    .tabs button:hover {
      background-color: #dee2e6;
    }
    .tabs button.active {
      background-color: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    input,
    select,
    textarea,
    button {
      width: 100%;
      padding: 11px;
      margin: 7px 0;
      border: 1px solid #ced4da;
      border-radius: 5px;
      font-size: 1rem;
    }
    button {
      background-color: var(--primary);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover {
      opacity: 0.92;
    }
    .btn-success {
      background-color: var(--success);
    }
    .btn-warning {
      background-color: var(--warning);
      color: var(--dark);
    }
    .btn-danger {
      background-color: var(--danger);
    }
    .result {
      background-color: #eef6ff;
      padding: 16px;
      border-radius: 7px;
      margin-top: 16px;
      white-space: pre-wrap;
    }
    .doctor-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }
    .doctor-card {
      border: 1px solid #e0e0e0;
      padding: 14px;
      border-radius: 8px;
      background-color: #fafafa;
      box-shadow: 0 2px 5px rgba(0,0,0,0.06);
    }
    .doctor-card h4 {
      margin: 0 0 8px 0;
      color: var(--dark);
      font-size: 1.05rem;
    }
    .doctor-card p {
      margin: 4px 0;
      font-size: 0.92rem;
    }
    .ticket {
      border: 2px dashed var(--primary);
      padding: 22px;
      margin: 22px 0;
      background-color: #f9f9ff;
      text-align: center;
      border-radius: 9px;
    }
    .ticket h3 {
      color: var(--primary);
      margin-bottom: 14px;
    }
    .ticket p {
      margin: 7px 0;
    }
    .ticket-id {
      font-size: 0.86rem;
      color: #666;
      margin-top: 14px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 14px;
    }
    th,
    td {
      padding: 11px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    th {
      background-color: #f8f9fa;
      font-weight: bold;
    }
    @media print {
      body * {
        visibility: hidden;
      }
      .ticket,
      .ticket * {
        visibility: visible;
      }
      .ticket {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        margin: 0;
        padding: 22px;
        box-sizing: border-box;
      }
      button {
        display: none !important;
      }
    }
    .footer-note {
      text-align: center;
      font-size: 0.87rem;
      color: #6c757d;
      margin-top: 32px;
      padding-top: 16px;
      border-top: 1px solid #eee;
    }
    .loading {
      text-align: center;
      padding: 20px;
      color: var(--primary);
    }
    .appointment-item {
      padding: 12px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      margin-bottom: 12px;
      background: #fafafa;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }
    .stat-card {
      background: white;
      padding: 16px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .stat-value {
      font-size: 1.8rem;
      font-weight: bold;
      color: var(--primary);
    }
    .log {
      font-family: monospace;
      font-size: 0.85rem;
      background: #f1f1f1;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
      max-height: 150px;
      overflow-y: auto;
    }
  </style>
</head>
<body>

<!-- –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ -->
<div id="loginScreen" class="container">
  <div class="card" style="max-width: 440px; margin: 110px auto;">
    <h2 style="text-align: center; margin-bottom: 22px; color: var(--dark);">üîê –í—Ö–æ–¥ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>
    <input type="text" id="login" placeholder="–õ–æ–≥–∏–Ω" value="dem" autocomplete="off" />
    <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" value="0506" autocomplete="off" />
    <button onclick="login()">–í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</button>
    <p style="font-size: 13.5px; color: #666; margin-top: 16px; text-align: center;">
      –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —É—á—ë—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:<br>
      <b>–õ–æ–≥–∏–Ω:</b> dem &nbsp; | &nbsp; <b>–ü–∞—Ä–æ–ª—å:</b> 0506
    </p>
  </div>
</div>

<!-- –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ -->
<div id="mainApp" class="container hidden">
  <header>
    <h1>üè• –ü–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞ ¬´–†–µ–Ω–µ—Å—Å–∞–Ω—Å¬ª ‚Äî –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è</h1>
    <button onclick="logout()">–í—ã–π—Ç–∏</button>
  </header>

  <div class="tabs">
    <button class="tab-btn active" data-tab="dashboard">üìä –ü–∞–Ω–µ–ª—å</button>
    <button class="tab-btn" data-tab="doctors">üë®‚Äç‚öïÔ∏è –í—Ä–∞—á–∏ (50)</button>
    <button class="tab-btn" data-tab="register">‚ûï –ü–∞—Ü–∏–µ–Ω—Ç—ã</button>
    <button class="tab-btn" data-tab="appointment">üìÖ –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</button>
    <button class="tab-btn" data-tab="myAppointments">üìã –ú–æ–∏ –∑–∞–ø–∏—Å–∏</button>
    <button class="tab-btn" data-tab="medical">ü©∫ –ú–µ–¥–∫–∞—Ä—Ç–∞</button>
    <button class="tab-btn" data-tab="tickets">üé´ –¢–∞–ª–æ–Ω—ã</button>
    <button class="tab-btn" data-tab="logs">üìù –õ–æ–≥–∏</button>
  </div>

  <!-- –ü–ê–ù–ï–õ–¨ -->
  <div id="dashboard" class="card tab-content active">
    <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∏</h3>
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="statPatients">‚Äî</div>
        <div>–ü–∞—Ü–∏–µ–Ω—Ç–æ–≤</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statAppointments">‚Äî</div>
        <div>–ó–∞–ø–∏—Å–µ–π —Å–µ–≥–æ–¥–Ω—è</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statDoctors">50</div>
        <div>–í—Ä–∞—á–µ–π</div>
      </div>
    </div>
    <p style="margin-top: 20px;">–°–∏—Å—Ç–µ–º–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç <b>50 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –≤—Ä–∞—á–µ–π</b> —Å –≥—Ä–∞—Ñ–∏–∫–æ–º –Ω–∞ 365 –¥–Ω–µ–π (–ø–Ω‚Äì–ø—Ç).</p>
  </div>

  <!-- –í–†–ê–ß–ò -->
  <div id="doctors" class="card tab-content hidden">
    <h3>–°–ø–∏—Å–æ–∫ 50 –≤—Ä–∞—á–µ–π –ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∏</h3>
    <p>–ö–∞–∂–¥—ã–π –≤—Ä–∞—á –∏–º–µ–µ—Ç –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫ –Ω–∞ 365 –¥–Ω–µ–π –≤–ø–µ—Ä—ë–¥. –°–ª–æ—Ç—ã: 09:00‚Äì17:00 (–ø–Ω‚Äì–ø—Ç).</p>
    <div id="doctorsList" class="loading">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã...</div>
  </div>

  <!-- –ü–ê–¶–ò–ï–ù–¢–´ -->
  <div id="register" class="card tab-content hidden">
    <h3>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞–º–∏</h3>
    <input id="regFio" placeholder="–§–ò–û –ø–æ–ª–Ω–æ—Å—Ç—å—é (–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á)" />
    <input id="regBirth" type="date" />
    <select id="regGender"><option value="">–ü–æ–ª</option><option value="–ú">–ú—É–∂—Å–∫–æ–π</option><option value="–ñ">–ñ–µ–Ω—Å–∫–∏–π</option></select>
    <input id="regPhone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω (+79991234567)" />
    <input id="regEmail" placeholder="Email (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" type="email" />
    <input id="regAddress" placeholder="–ê–¥—Ä–µ—Å –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è" />
    <input id="regPassport" placeholder="–ü–∞—Å–ø–æ—Ä—Ç (—Å–µ—Ä–∏—è –Ω–æ–º–µ—Ä, –Ω–∞–ø—Ä–∏–º–µ—Ä: 4507 123456)" />
    <input id="regSnils" placeholder="–°–ù–ò–õ–° (123-456-789 00)" />
    <input id="regInn" placeholder="–ò–ù–ù (12 —Ü–∏—Ñ—Ä)" />
    <button class="btn-success" onclick="registerPatient()">‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞</button>

    <h4 style="margin-top: 25px;">–ü–æ–∏—Å–∫ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h4>
    <input id="searchQuery" placeholder="–§–ò–û, –ø–∞—Å–ø–æ—Ä—Ç, –°–ù–ò–õ–° –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω..." />
    <button onclick="searchPatient()">–ù–∞–π—Ç–∏ –ø–∞—Ü–∏–µ–Ω—Ç–∞</button>
    <div id="searchResult" class="result"></div>
    <div id="editForm" class="hidden">
      <input id="editKey" type="hidden" />
      <input id="editFio" placeholder="–§–ò–û" />
      <input id="editBirth" type="date" />
      <select id="editGender"><option value="">–ü–æ–ª</option><option value="–ú">–ú—É–∂—Å–∫–æ–π</option><option value="–ñ">–ñ–µ–Ω—Å–∫–∏–π</option></select>
      <input id="editPhone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" />
      <input id="editEmail" placeholder="Email" />
      <input id="editAddress" placeholder="–ê–¥—Ä–µ—Å" />
      <input id="editPassport" placeholder="–ü–∞—Å–ø–æ—Ä—Ç" />
      <input id="editSnils" placeholder="–°–ù–ò–õ–°" />
      <input id="editInn" placeholder="–ò–ù–ù" />
      <button class="btn-success" onclick="savePatient()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
      <button class="btn-danger" onclick="deletePatient()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞</button>
      <button onclick="cancelEdit()">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>

  <!-- –ù–û–í–ê–Ø –ó–ê–ü–ò–°–¨ -->
  <div id="appointment" class="card tab-content hidden">
    <h3>–ó–∞–ø–∏—Å—å –Ω–∞ –ø—Ä–∏—ë–º –∫ –≤—Ä–∞—á—É</h3>
    <input id="appPassport" placeholder="–ü–∞—Å–ø–æ—Ä—Ç –ø–∞—Ü–∏–µ–Ω—Ç–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" />
    <select id="appDoctor"><option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–∞—á–∞ ‚Äî</option></select>
    <input id="appDate" type="date" />
    <select id="appTime"><option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è ‚Äî</option></select>
    <button class="btn-success" onclick="bookAppointment()">üìÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
    <div id="appResult" class="result"></div>
  </div>

  <!-- –£–ü–†–ê–í–õ–ï–ù–ò–ï –ó–ê–ü–ò–°–Ø–ú–ò -->
  <div id="myAppointments" class="card tab-content hidden">
    <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–º–µ–Ω–∞ –∑–∞–ø–∏—Å–µ–π</h3>
    <p>–í–≤–µ–¥–∏—Ç–µ –ø–∞—Å–ø–æ—Ä—Ç –∏–ª–∏ –§–ò–û –ø–∞—Ü–∏–µ–Ω—Ç–∞, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –µ–≥–æ –∑–∞–ø–∏—Å–∏.</p>
    <input id="managePassport" placeholder="–ü–∞—Å–ø–æ—Ä—Ç –∏–ª–∏ –§–ò–û" />
    <button onclick="findAppointments()">–ù–∞–π—Ç–∏ –∑–∞–ø–∏—Å–∏</button>
    <div id="appointmentsList" class="result"></div>
  </div>

  <!-- –ú–ï–î–ö–ê–†–¢–ê -->
  <div id="medical" class="card tab-content hidden">
    <h3>–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –∫–∞—Ä—Ç–∞ –ø–∞—Ü–∏–µ–Ω—Ç–∞</h3>
    <input id="medPassport" placeholder="–ü–∞—Å–ø–æ—Ä—Ç –ø–∞—Ü–∏–µ–Ω—Ç–∞" />
    <button onclick="loadMedicalRecord()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –º–µ–¥–∫–∞—Ä—Ç—É</button>
    <div id="medicalData" class="result"></div>

    <h4 style="margin-top: 22px;">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –ø–æ—Å–µ—â–µ–Ω–∏–µ</h4>
    <textarea id="medDiagnosis" placeholder="–î–∏–∞–≥–Ω–æ–∑ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –û–†–í–ò, –≥–∏–ø–µ—Ä—Ç–æ–Ω–∏—è)" rows="2"></textarea>
    <textarea id="medConclusion" placeholder="–ó–∞–∫–ª—é—á–µ–Ω–∏–µ –≤—Ä–∞—á–∞" rows="3"></textarea>
    <textarea id="medPrescription" placeholder="–ù–∞–∑–Ω–∞—á–µ–Ω–∏—è, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –∞–Ω–∞–ª–∏–∑—ã" rows="2"></textarea>
    <button class="btn-success" onclick="addMedicalVisit()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
  </div>

  <!-- –¢–ê–õ–û–ù–´ -->
  <div id="tickets" class="card tab-content hidden">
    <h3>–ü–µ—á–∞—Ç—å —Ç–∞–ª–æ–Ω–∞ –Ω–∞ –ø—Ä–∏—ë–º</h3>
    <p>–ü–æ—Å–ª–µ –∑–∞–ø–∏—Å–∏ —Ç–∞–ª–æ–Ω –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å. –ù–∞–∂–º–∏—Ç–µ ¬´–†–∞—Å–ø–µ—á–∞—Ç–∞—Ç—å¬ª, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ PDF.</p>
    <div id="ticketContainer"></div>
  </div>

  <!-- –õ–û–ì–ò -->
  <div id="logs" class="card tab-content hidden">
    <h3>–°–∏—Å—Ç–µ–º–Ω—ã–µ –ª–æ–≥–∏</h3>
    <p>–û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞.</p>
    <div id="systemLog" class="log">–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ...</div>
    <button onclick="clearLog()">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
  </div>

  <div class="footer-note">
    –ü–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞ ¬´–†–µ–Ω–µ—Å—Å–∞–Ω—Å¬ª ‚Äî –í–µ—Ä—Å–∏—è —Å 50 –≤—Ä–∞—á–∞–º–∏ | –ì—Ä–∞—Ñ–∏–∫ –Ω–∞ 365 –¥–Ω–µ–π | ¬© 2025
  </div>
</div>

<script>
  // === –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ª–æ–≥–≥–µ—Ä ===
  function log(msg) {
    const logDiv = document.getElementById("systemLog");
    if (logDiv) {
      const now = new Date().toLocaleTimeString();
      logDiv.innerHTML += `[${now}] ${msg}\n`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }
    console.log(msg);
  }

  // === Firebase ===
  const firebaseConfig = {
    databaseURL: "https://renessans-bank-3df94-default-rtdb.europe-west1.firebasedatabase.app/"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // === –í—Ö–æ–¥ ===
  function login() {
    const l = document.getElementById("login").value.trim();
    const p = document.getElementById("password").value.trim();
    if (l === "dem" && p === "0506") {
      document.getElementById("loginScreen").classList.add("hidden");
      document.getElementById("mainApp").classList.remove("hidden");
      log("–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã...");
      initializeSystemWith50Doctors();
      loadStats();
    } else {
      alert("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å.");
      log("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: –Ω–µ–≤–µ—Ä–Ω—ã–µ —É—á—ë—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ");
    }
  }

  function logout() {
    document.getElementById("mainApp").classList.add("hidden");
    document.getElementById("loginScreen").classList.remove("hidden");
    log("–í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã");
  }

  // === –í–∫–ª–∞–¥–∫–∏ ===
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        btn.classList.add('active');
        document.getElementById(btn.dataset.tab).classList.remove('hidden');
      });
    });
  });

  // === –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –§–ò–û –∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–µ–π ===
  const firstNamesM = ["–ê–ª–µ–∫—Å–∞–Ω–¥—Ä", "–î–º–∏—Ç—Ä–∏–π", "–°–µ—Ä–≥–µ–π", "–ê–Ω–¥—Ä–µ–π", "–ò–≤–∞–Ω", "–ú–∏—Ö–∞–∏–ª", "–ù–∏–∫–æ–ª–∞–π", "–í–ª–∞–¥–∏–º–∏—Ä", "–ü–∞–≤–µ–ª", "–ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏–Ω", "–Æ—Ä–∏–π", "–í–∏–∫—Ç–æ—Ä", "–û–ª–µ–≥", "–ë–æ—Ä–∏—Å", "–ê—Ä—Ç—ë–º", "–†–æ–º–∞–Ω", "–ò–ª—å—è", "–°—Ç–∞–Ω–∏—Å–ª–∞–≤", "–ì—Ä–∏–≥–æ—Ä–∏–π", "–õ–µ–æ–Ω–∏–¥", "–ï–≤–≥–µ–Ω–∏–π", "–í–∞–ª–µ—Ä–∏–π", "–ê–Ω–∞—Ç–æ–ª–∏–π", "–í–ª–∞–¥–∏—Å–ª–∞–≤", "–Ø—Ä–æ—Å–ª–∞–≤"];
  const firstNamesF = ["–ê–Ω–Ω–∞", "–ï–ª–µ–Ω–∞", "–û–ª—å–≥–∞", "–ù–∞—Ç–∞–ª—å—è", "–ò—Ä–∏–Ω–∞", "–°–≤–µ—Ç–ª–∞–Ω–∞", "–¢–∞—Ç—å—è–Ω–∞", "–ú–∞—Ä–∏–Ω–∞", "–ï–∫–∞—Ç–µ—Ä–∏–Ω–∞", "–ê–ª—ë–Ω–∞", "–Æ–ª–∏—è", "–í–∏–∫—Ç–æ—Ä–∏—è", "–î–∞—Ä—å—è", "–ö—Å–µ–Ω–∏—è", "–ü–æ–ª–∏–Ω–∞", "–ê–Ω–∞—Å—Ç–∞—Å–∏—è", "–ú–∞—Ä–∏—è", "–ê–ª–µ–∫—Å–∞–Ω–¥—Ä–∞", "–í–µ—Ä–æ–Ω–∏–∫–∞", "–õ—é–¥–º–∏–ª–∞", "–ï–ª–∏–∑–∞–≤–µ—Ç–∞", "–í–∞–ª–µ–Ω—Ç–∏–Ω–∞", "–ò–Ω–Ω–∞", "–°–æ—Ñ—å—è", "–ú–∏–ª–∞–Ω–∞"];
  const lastNames = ["–ò–≤–∞–Ω–æ–≤", "–°–º–∏—Ä–Ω–æ–≤", "–ö—É–∑–Ω–µ—Ü–æ–≤", "–ü–æ–ø–æ–≤", "–í–∞—Å–∏–ª—å–µ–≤", "–ü–µ—Ç—Ä–æ–≤", "–°–æ–∫–æ–ª–æ–≤", "–ú–∏—Ö–∞–π–ª–æ–≤", "–ù–æ–≤–∏–∫–æ–≤", "–§—ë–¥–æ—Ä–æ–≤", "–ú–æ—Ä–æ–∑–æ–≤", "–í–æ–ª–∫–æ–≤", "–ê–ª–µ–∫—Å–µ–µ–≤", "–õ–µ–±–µ–¥–µ–≤", "–°–µ–º—ë–Ω–æ–≤", "–ï–≥–æ—Ä–æ–≤", "–ü–∞–≤–ª–æ–≤", "–ö–æ–∑–ª–æ–≤", "–°—Ç–µ–ø–∞–Ω–æ–≤", "–ù–∏–∫–∏—Ç–∏–Ω", "–û—Ä–ª–æ–≤", "–ê–Ω–¥—Ä–µ–µ–≤", "–ú–∞–∫–∞—Ä–æ–≤", "–ù–∏–∫–æ–ª–∞–µ–≤", "–ó–∞—Ö–∞—Ä–æ–≤", "–ó–∞–π—Ü–µ–≤", "–°–æ–ª–æ–≤—å—ë–≤", "–ë–æ—Ä–∏—Å–æ–≤", "–Ø–∫–æ–≤–ª–µ–≤", "–ì—Ä–∏–≥–æ—Ä—å–µ–≤"];
  const patronymicsM = ["–ê–ª–µ–∫—Å–∞–Ω–¥—Ä–æ–≤–∏—á", "–î–º–∏—Ç—Ä–∏–µ–≤–∏—á", "–°–µ—Ä–≥–µ–µ–≤–∏—á", "–ê–Ω–¥—Ä–µ–µ–≤–∏—á", "–ò–≤–∞–Ω–æ–≤–∏—á", "–ú–∏—Ö–∞–π–ª–æ–≤–∏—á", "–ù–∏–∫–æ–ª–∞–µ–≤–∏—á", "–í–ª–∞–¥–∏–º–∏—Ä–æ–≤–∏—á", "–ü–∞–≤–ª–æ–≤–∏—á", "–ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏–Ω–æ–≤–∏—á", "–Æ—Ä—å–µ–≤–∏—á", "–í–∏–∫—Ç–æ—Ä–æ–≤–∏—á", "–û–ª–µ–≥–æ–≤–∏—á", "–ë–æ—Ä–∏—Å–æ–≤–∏—á", "–ê—Ä—Ç—ë–º–æ–≤–∏—á", "–†–æ–º–∞–Ω–æ–≤–∏—á", "–ò–ª—å–∏—á", "–°—Ç–∞–Ω–∏—Å–ª–∞–≤–æ–≤–∏—á", "–ì—Ä–∏–≥–æ—Ä—å–µ–≤–∏—á", "–õ–µ–æ–Ω–∏–¥–æ–≤–∏—á"];
  const patronymicsF = ["–ê–ª–µ–∫—Å–∞–Ω–¥—Ä–æ–≤–Ω–∞", "–î–º–∏—Ç—Ä–∏–µ–≤–Ω–∞", "–°–µ—Ä–≥–µ–µ–≤–Ω–∞", "–ê–Ω–¥—Ä–µ–µ–≤–Ω–∞", "–ò–≤–∞–Ω–æ–≤–Ω–∞", "–ú–∏—Ö–∞–π–ª–æ–≤–Ω–∞", "–ù–∏–∫–æ–ª–∞–µ–≤–Ω–∞", "–í–ª–∞–¥–∏–º–∏—Ä–æ–≤–Ω–∞", "–ü–∞–≤–ª–æ–≤–Ω–∞", "–ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏–Ω–æ–≤–Ω–∞", "–Æ—Ä—å–µ–≤–Ω–∞", "–í–∏–∫—Ç–æ—Ä–æ–≤–Ω–∞", "–û–ª–µ–≥–æ–≤–Ω–∞", "–ë–æ—Ä–∏—Å–æ–≤–Ω–∞", "–ê—Ä—Ç—ë–º–æ–≤–Ω–∞", "–†–æ–º–∞–Ω–æ–≤–Ω–∞", "–ò–ª—å–∏–Ω–∏—á–Ω–∞", "–°—Ç–∞–Ω–∏—Å–ª–∞–≤–æ–≤–Ω–∞", "–ì—Ä–∏–≥–æ—Ä—å–µ–≤–Ω–∞", "–õ–µ–æ–Ω–∏–¥–æ–≤–Ω–∞"];
  const specialties = [
    "–¢–µ—Ä–∞–ø–µ–≤—Ç", "–•–∏—Ä—É—Ä–≥", "–û—Ñ—Ç–∞–ª—å–º–æ–ª–æ–≥", "–ì–∏–Ω–µ–∫–æ–ª–æ–≥", "–ö–∞—Ä–¥–∏–æ–ª–æ–≥", "–ù–µ–≤—Ä–æ–ª–æ–≥", "–î–µ—Ä–º–∞—Ç–æ–ª–æ–≥", 
    "–≠–Ω–¥–æ–∫—Ä–∏–Ω–æ–ª–æ–≥", "–ü–µ–¥–∏–∞—Ç—Ä", "–û—Ç–æ—Ä–∏–Ω–æ–ª–∞—Ä–∏–Ω–≥–æ–ª–æ–≥", "–£—Ä–æ–ª–æ–≥", "–û–Ω–∫–æ–ª–æ–≥", "–ü—Å–∏—Ö–∏–∞—Ç—Ä", "–¢—Ä–∞–≤–º–∞—Ç–æ–ª–æ–≥", 
    "–†–µ–Ω—Ç–≥–µ–Ω–æ–ª–æ–≥", "–ê–ª–ª–µ—Ä–≥–æ–ª–æ–≥", "–ì–∞—Å—Ç—Ä–æ—ç–Ω—Ç–µ—Ä–æ–ª–æ–≥", "–ü—É–ª—å–º–æ–Ω–æ–ª–æ–≥", "–ù–µ—Ñ—Ä–æ–ª–æ–≥", "–ò–º–º—É–Ω–æ–ª–æ–≥",
    "–ù–µ–≤—Ä–æ–ø–∞—Ç–æ–ª–æ–≥", "–ö–∞—Ä–¥–∏–æ—Ö–∏—Ä—É—Ä–≥", "–û—Ä—Ç–æ–ø–µ–¥", "–°—Ç–æ–º–∞—Ç–æ–ª–æ–≥", "–ù–∞—Ä–∫–æ–ª–æ–≥"
  ];

  // === –ì—Ä–∞—Ñ–∏–∫ –Ω–∞ 365 –¥–Ω–µ–π (–ø–Ω‚Äì–ø—Ç) ===
  function generateSchedule365() {
    const schedule = {};
    const today = new Date();
    const slots = ["09:00", "10:00", "11:00", "12:00", "14:00", "15:00", "16:00", "17:00"];
    for (let i = 0; i < 365; i++) {
      const d = new Date(today);
      d.setDate(d.getDate() + i);
      const day = d.getDay();
      if (day === 0 || day === 6) continue; // –≤—ã—Ö–æ–¥–Ω—ã–µ
      const dateStr = d.toISOString().split('T')[0];
      schedule[dateStr] = [...slots];
    }
    return schedule;
  }

  // === –ì–µ–Ω–µ—Ä–∞—Ü–∏—è 50 –≤—Ä–∞—á–µ–π ===
  function generate50Doctors() {
    const doctors = {};
    const fullSchedule = generateSchedule365();
    for (let i = 1; i <= 50; i++) {
      const isMale = Math.random() > 0.5;
      let firstName, patronymic;
      if (isMale) {
        firstName = firstNamesM[Math.floor(Math.random() * firstNamesM.length)];
        patronymic = patronymicsM[Math.floor(Math.random() * patronymicsM.length)];
      } else {
        firstName = firstNamesF[Math.floor(Math.random() * firstNamesF.length)];
        patronymic = patronymicsF[Math.floor(Math.random() * patronymicsF.length)];
      }
      const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
      const fio = `${lastName} ${firstName} ${patronymic}`;
      const specialty = specialties[Math.floor(Math.random() * specialties.length)];
      const experience = Math.floor(Math.random() * 25) + 3; // 3‚Äì27 –ª–µ—Ç
      doctors[`doc${i.toString().padStart(2, '0')}`] = {
        fio,
        specialty,
        experience: `${experience} –ª–µ—Ç`,
        schedule: fullSchedule
      };
    }
    return doctors;
  }

  // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã —Å 50 –≤—Ä–∞—á–∞–º–∏ (–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è) ===
  function initializeSystemWith50Doctors() {
    const listDiv = document.getElementById("doctorsList");
    listDiv.innerHTML = "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö...";
    log("–ù–∞—á–∞–ª–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ Firebase");

    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã—Ö –≤—Ä–∞—á–µ–π, —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —á–∏—Å—Ç—ã–π —Å—Ç–∞—Ä—Ç
    db.ref("staff").remove()
      .then(() => {
        log("–°—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –≤—Ä–∞—á–µ–π —É–¥–∞–ª–µ–Ω—ã");
        const doctors50 = generate50Doctors();
        log(`–°–æ–∑–¥–∞–Ω–æ ${Object.keys(doctors50).length} –≤—Ä–∞—á–µ–π`);
        return db.ref("staff").set(doctors50);
      })
      .then(() => {
        log("50 –≤—Ä–∞—á–µ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–ø–∏—Å–∞–Ω—ã –≤ Firebase");
        listDiv.innerHTML = "‚úÖ 50 –≤—Ä–∞—á–µ–π —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã!";
        setTimeout(() => {
          loadDoctorsUI();
          loadDoctorsToSelect();
        }, 1000);
      })
      .catch(error => {
        console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:", error);
        log("–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: " + error.message);
        listDiv.innerHTML = "‚ùå –û—à–∏–±–∫–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ Firebase.";
      });
  }

  // === –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Ä–∞—á–µ–π ===
  function loadDoctorsUI() {
    const container = document.getElementById("doctorsList");
    container.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –≤—Ä–∞—á–µ–π...";
    log("–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –≤—Ä–∞—á–µ–π –∏–∑ Firebase");

    db.ref("staff").once("value")
      .then(snapshot => {
        container.innerHTML = "";
        let count = 0;
        snapshot.forEach(doc => {
          const d = doc.val();
          const dates = Object.keys(d.schedule).sort();
          const next = dates.slice(0, 2).join(", ");
          const card = document.createElement("div");
          card.className = "doctor-card";
          card.innerHTML = `
            <h4>${d.fio}</h4>
            <p><strong>–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å:</strong> ${d.specialty}</p>
            <p><strong>–°—Ç–∞–∂:</strong> ${d.experience}</p>
            <p><strong>–ë–ª–∏–∂–∞–π—à–∏–µ –¥–Ω–∏:</strong> ${next || "‚Äî"}</p>
          `;
          container.appendChild(card);
          count++;
        });
        log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${count} –≤—Ä–∞—á–µ–π`);
        if (count === 0) container.innerHTML = "<p>–í—Ä–∞—á–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>";
      })
      .catch(err => {
        log("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Ä–∞—á–µ–π: " + err.message);
      });
  }

  // === –ó–∞–≥—Ä—É–∑–∫–∞ –≤ —Å–µ–ª–µ–∫—Ç ===
  function loadDoctorsToSelect() {
    const sel = document.getElementById("appDoctor");
    if (!sel) return;
    sel.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–∞—á–∞ ‚Äî</option>';
    log("–ó–∞–≥—Ä—É–∑–∫–∞ –≤—Ä–∞—á–µ–π –≤ –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫");

    db.ref("staff").once("value")
      .then(snapshot => {
        snapshot.forEach(doc => {
          const d = doc.val();
          const opt = document.createElement("option");
          opt.value = doc.key;
          opt.textContent = `${d.fio} (${d.specialty})`;
          sel.appendChild(opt);
        });
        log("–í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –≤—Ä–∞—á–µ–π –∑–∞–ø–æ–ª–Ω–µ–Ω");
      })
      .catch(err => {
        log("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –≤—Ä–∞—á–µ–π: " + err.message);
      });
  }

  // === –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–∞—Ü–∏–µ–Ω—Ç–∞ ===
  function registerPatient() {
    const fio = document.getElementById("regFio").value.trim();
    const birth = document.getElementById("regBirth").value;
    const gender = document.getElementById("regGender").value;
    const phone = document.getElementById("regPhone").value.trim();
    const email = document.getElementById("regEmail").value.trim();
    const address = document.getElementById("regAddress").value.trim();
    const passport = document.getElementById("regPassport").value.trim();
    const snils = document.getElementById("regSnils").value.trim();
    const inn = document.getElementById("regInn").value.trim();

    if (!fio || !passport || !birth) {
      alert("‚ùå –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ: –§–ò–û, –ø–∞—Å–ø–æ—Ä—Ç, –¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è.");
      log("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö");
      return;
    }

    const key = passport.replace(/\s+/g, "_");
    db.ref("patients/" + key).set({
      fio, birth, gender, phone, email, address, passport, snils, inn,
      createdAt: new Date().toISOString()
    }).then(() => {
      alert("‚úÖ –ü–∞—Ü–∏–µ–Ω—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω!");
      log(`–ü–∞—Ü–∏–µ–Ω—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: ${fio} (${passport})`);
      document.querySelectorAll("#register input, select, textarea").forEach(el => el.value = "");
    }).catch(err => {
      log("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–∞—Ü–∏–µ–Ω—Ç–∞: " + err.message);
      alert("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞.");
    });
  }

  // === –ü–æ–∏—Å–∫ –ø–∞—Ü–∏–µ–Ω—Ç–∞ ===
  function searchPatient() {
    const q = document.getElementById("searchQuery").value.trim().toLowerCase();
    if (!q) {
      alert("–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–∏—Å–∫–∞.");
      return;
    }

    db.ref("patients").once("value")
      .then(snapshot => {
        let found = null;
        snapshot.forEach(p => {
          const pat = p.val();
          const fields = [pat.fio, pat.passport, pat.snils, pat.phone, pat.email, pat.address];
          if (fields.some(f => f && f.toLowerCase().includes(q))) {
            found = { key: p.key, ...pat };
            return false;
          }
        });

        const res = document.getElementById("searchResult");
        const edit = document.getElementById("editForm");
        if (found) {
          res.innerHTML = `<p><b>${found.fio}</b><br>–ü–∞—Å–ø–æ—Ä—Ç: ${found.passport}<br>–¢–µ–ª–µ—Ñ–æ–Ω: ${found.phone || '‚Äî'}</p>`;
          document.getElementById("editKey").value = found.key;
          document.getElementById("editFio").value = found.fio || '';
          document.getElementById("editBirth").value = found.birth || '';
          document.getElementById("editGender").value = found.gender || '';
          document.getElementById("editPhone").value = found.phone || '';
          document.getElementById("editEmail").value = found.email || '';
          document.getElementById("editAddress").value = found.address || '';
          document.getElementById("editPassport").value = found.passport || '';
          document.getElementById("editSnils").value = found.snils || '';
          document.getElementById("editInn").value = found.inn || '';
          edit.classList.remove("hidden");
          log(`–ù–∞–π–¥–µ–Ω –ø–∞—Ü–∏–µ–Ω—Ç: ${found.fio}`);
        } else {
          res.innerHTML = "‚ùå –ü–∞—Ü–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω";
          edit.classList.add("hidden");
          log("–ü–∞—Ü–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ –∑–∞–ø—Ä–æ—Å—É: " + q);
        }
      })
      .catch(err => {
        log("–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–∞—Ü–∏–µ–Ω—Ç–∞: " + err.message);
      });
  }

  // === –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π ===
  function savePatient() {
    const key = document.getElementById("editKey").value;
    if (!key) {
      alert("‚ùå –û—à–∏–±–∫–∞ –∫–ª—é—á–∞.");
      return;
    }

    const data = {
      fio: document.getElementById("editFio").value.trim(),
      birth: document.getElementById("editBirth").value,
      gender: document.getElementById("editGender").value,
      phone: document.getElementById("editPhone").value.trim(),
      email: document.getElementById("editEmail").value.trim(),
      address: document.getElementById("editAddress").value.trim(),
      passport: document.getElementById("editPassport").value.trim(),
      snils: document.getElementById("editSnils").value.trim(),
      inn: document.getElementById("editInn").value.trim()
    };

    if (!data.fio || !data.passport) {
      alert("‚ùå –§–ò–û –∏ –ø–∞—Å–ø–æ—Ä—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã.");
      return;
    }

    db.ref("patients/" + key).update(data).then(() => {
      alert("‚úÖ –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!");
      log(`–î–∞–Ω–Ω—ã–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã: ${data.fio}`);
      cancelEdit();
    }).catch(err => {
      log("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ü–∏–µ–Ω—Ç–∞: " + err.message);
      alert("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è.");
    });
  }

  // === –£–¥–∞–ª–µ–Ω–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞ ===
  function deletePatient() {
    if (!confirm("–£–¥–∞–ª–∏—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞ –∏ –≤—Å–µ –µ–≥–æ –∑–∞–ø–∏—Å–∏?")) return;
    const key = document.getElementById("editKey").value;
    db.ref("patients/" + key).remove()
      .then(() => {
        alert("‚úÖ –ü–∞—Ü–∏–µ–Ω—Ç —É–¥–∞–ª—ë–Ω.");
        log(`–ü–∞—Ü–∏–µ–Ω—Ç —É–¥–∞–ª—ë–Ω: –∫–ª—é—á=${key}`);
        cancelEdit();
      })
      .catch(err => {
        log("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–∞—Ü–∏–µ–Ω—Ç–∞: " + err.message);
        alert("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞.");
      });
  }

  function cancelEdit() {
    document.getElementById("editForm").classList.add("hidden");
    document.getElementById("searchQuery").value = "";
    document.getElementById("searchResult").innerHTML = "";
  }

  // === –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ ===
  document.addEventListener("DOMContentLoaded", () => {
    const docSel = document.getElementById("appDoctor");
    const dateInp = document.getElementById("appDate");
    if (docSel && dateInp) {
      docSel.addEventListener("change", updateAvailableTimes);
      dateInp.addEventListener("change", updateAvailableTimes);
    }
  });

  function updateAvailableTimes() {
    const docId = document.getElementById("appDoctor")?.value;
    const date = document.getElementById("appDate")?.value;
    const timeSel = document.getElementById("appTime");
    if (!docId || !date || !timeSel) return;

    timeSel.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>';
    log(`–ó–∞–ø—Ä–æ—Å –≤—Ä–µ–º–µ–Ω–∏: –≤—Ä–∞—á=${docId}, –¥–∞—Ç–∞=${date}`);

    db.ref(`staff/${docId}/schedule/${date}`).once("value")
      .then(snap => {
        const all = snap.val() || [];
        if (all.length === 0) {
          timeSel.innerHTML = '<option value="">–ù–µ—Ç —Ä–∞–±–æ—á–∏—Ö —Å–ª–æ—Ç–æ–≤</option>';
          log("–ù–µ—Ç —Ä–∞–±–æ—á–∏—Ö —Å–ª–æ—Ç–æ–≤ –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å");
          return;
        }
        return db.ref("appointments").orderByChild("doctorDate").equalTo(`${docId}_${date}`).once("value")
          .then(appts => {
            const busy = {};
            appts.forEach(a => { busy[a.val().time] = true; });
            return { all, busy };
          });
      })
      .then(({ all, busy }) => {
        timeSel.innerHTML = "";
        let hasFree = false;
        all.filter(t => !busy[t]).forEach(t => {
          const opt = document.createElement("option");
          opt.value = t;
          opt.textContent = t;
          timeSel.appendChild(opt);
          hasFree = true;
        });
        if (!hasFree) {
          timeSel.innerHTML = '<option value="">–í—Å–µ —Å–ª–æ—Ç—ã –∑–∞–Ω—è—Ç—ã</option>';
          log("–í—Å–µ —Å–ª–æ—Ç—ã –∑–∞–Ω—è—Ç—ã");
        } else {
          log(`–ù–∞–π–¥–µ–Ω–æ ${all.filter(t => !busy[t]).length} —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤`);
        }
      })
      .catch(err => {
        timeSel.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
        log("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Ä–µ–º–µ–Ω–∏: " + err.message);
      });
  }

  // === –ó–∞–ø–∏—Å—å ===
  function bookAppointment() {
    const passport = document.getElementById("appPassport")?.value.trim();
    const docId = document.getElementById("appDoctor")?.value;
    const date = document.getElementById("appDate")?.value;
    const time = document.getElementById("appTime")?.value;
    if (!passport || !docId || !date || !time) {
      alert("‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è.");
      log("–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏: –Ω–µ –≤—Å–µ –ø–æ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã");
      return;
    }

    const key = `${date}_${docId}_${time}`;
    const ticketId = "T" + Date.now().toString(36).toUpperCase();

    db.ref("appointments/" + key).set({
      patientPassport: passport,
      doctorId: docId,
      date, time,
      ticketId,
      doctorDate: `${docId}_${date}`,
      status: "confirmed",
      createdAt: new Date().toISOString()
    }).then(() => {
      log(`–ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞: ${passport} ‚Üí ${docId} –Ω–∞ ${date} ${time}`);
      document.getElementById("appResult").innerHTML = "‚úÖ –ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞!";
      showTicket(passport, docId, date, time, ticketId);
      updateAvailableTimes();
    }).catch(err => {
      log("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏: " + err.message);
      alert("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å.");
    });
  }

  // === –¢–∞–ª–æ–Ω ===
  function showTicket(passport, doctorId, date, time, ticketId) {
    Promise.all([
      db.ref("patients/" + passport.replace(/\s+/g, "_")).once("value"),
      db.ref("staff/" + doctorId).once("value")
    ]).then(([patSnap, docSnap]) => {
      const pat = patSnap.val();
      const doc = docSnap.val();
      document.getElementById("ticketContainer").innerHTML = `
        <div class="ticket">
          <h3>–¢–∞–ª–æ–Ω –Ω–∞ –ø—Ä–∏—ë–º</h3>
          <p><strong>–ü–∞—Ü–∏–µ–Ω—Ç:</strong> ${pat?.fio || '‚Äî'}</p>
          <p><strong>–í—Ä–∞—á:</strong> ${doc?.fio || '‚Äî'} (${doc?.specialty || '‚Äî'})</p>
          <p><strong>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è:</strong> ${date} –≤ ${time}</p>
          <p><strong>–ö–∞–±–∏–Ω–µ—Ç:</strong> 305</p>
          <p class="ticket-id">ID: ${ticketId}</p>
        </div>
        <button onclick="window.print()">üñ®Ô∏è –†–∞—Å–ø–µ—á–∞—Ç–∞—Ç—å</button>
      `;
      document.querySelector('.tab-btn[data-tab="tickets"]').click();
      log("–¢–∞–ª–æ–Ω —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω");
    }).catch(err => {
      log("–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–∞–ª–æ–Ω–∞: " + err.message);
    });
  }

  // === –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å—è–º–∏ ===
  function findAppointments() {
    const query = document.getElementById("managePassport").value.trim().toLowerCase();
    if (!query) {
      alert("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Å–ø–æ—Ä—Ç –∏–ª–∏ –§–ò–û.");
      return;
    }

    Promise.all([
      db.ref("patients").once("value"),
      db.ref("appointments").once("value"),
      db.ref("staff").once("value")
    ]).then(([patSnap, appSnap, staffSnap]) => {
      const patients = {};
      patSnap.forEach(p => {
        const pat = p.val();
        if (pat.passport.toLowerCase().includes(query) || pat.fio.toLowerCase().includes(query)) {
          patients[p.key] = pat;
        }
      });

      if (Object.keys(patients).length === 0) {
        document.getElementById("appointmentsList").innerHTML = "<p>‚ùå –ü–∞—Ü–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.</p>";
        log("–ü–∞—Ü–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –∑–∞–ø–∏—Å–µ–π");
        return;
      }

      const appointments = [];
      appSnap.forEach(a => {
        const app = a.val();
        if (patients[app.patientPassport.replace(/\s+/g, "_")]) {
          appointments.push({ key: a.key, ...app });
        }
      });

      if (appointments.length === 0) {
        document.getElementById("appointmentsList").innerHTML = "<p>–£ –ø–∞—Ü–∏–µ–Ω—Ç–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π.</p>";
        log("–ó–∞–ø–∏—Å–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ");
        return;
      }

      let html = "<h4>–ù–∞–π–¥–µ–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏:</h4>";
      appointments.forEach(app => {
        const pat = patients[app.patientPassport.replace(/\s+/g, "_")];
        const doctor = staffSnap.val()[app.doctorId] || {};
        html += `
          <div class="appointment-item">
            <p><b>${pat.fio}</b> ‚Üí ${doctor.fio || '‚Äî'} (${doctor.specialty || '‚Äî'})</p>
            <p>üìÖ ${app.date} –≤ ${app.time} | ID: ${app.ticketId}</p>
            <button class="btn-warning" onclick="editAppointment('${app.key}', '${app.patientPassport}', '${app.doctorId}', '${app.date}', '${app.time}')">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</button>
            <button class="btn-danger" onclick="cancelAppointment('${app.key}')">‚ùå –û—Ç–º–µ–Ω–∏—Ç—å</button>
          </div>
        `;
      });
      document.getElementById("appointmentsList").innerHTML = html;
      log(`–ù–∞–π–¥–µ–Ω–æ ${appointments.length} –∑–∞–ø–∏—Å–µ–π`);
    }).catch(err => {
      log("–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –∑–∞–ø–∏—Å–µ–π: " + err.message);
    });
  }

  // === –û—Ç–º–µ–Ω–∞ –∑–∞–ø–∏—Å–∏ ===
  function cancelAppointment(key) {
    if (!confirm("–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å?")) return;
    db.ref("appointments/" + key).remove()
      .then(() => {
        alert("‚úÖ –ó–∞–ø–∏—Å—å –æ—Ç–º–µ–Ω–µ–Ω–∞. –í—Ä–µ–º—è –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–æ.");
        log(`–ó–∞–ø–∏—Å—å –æ—Ç–º–µ–Ω–µ–Ω–∞: –∫–ª—é—á=${key}`);
        findAppointments();
      })
      .catch(err => {
        log("–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –∑–∞–ø–∏—Å–∏: " + err.message);
        alert("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å.");
      });
  }

  // === –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ (—É–ø—Ä–æ—â—ë–Ω–Ω–æ–µ) ===
  function editAppointment(key, passport, doctorId, date, time) {
    alert("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –ø–æ–∫–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ –æ—Ç–º–µ–Ω—É + –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å. –≠—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ –≤ –ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞—Ö.");
  }

  // === –ú–µ–¥–∫–∞—Ä—Ç–∞ ===
  function loadMedicalRecord() {
    const passport = document.getElementById("medPassport")?.value.trim();
    if (!passport) {
      alert("–£–∫–∞–∂–∏—Ç–µ –ø–∞—Å–ø–æ—Ä—Ç.");
      return;
    }
    const key = passport.replace(/\s+/g, "_");
    db.ref("medicalRecords/" + key).once("value")
      .then(snap => {
        const data = snap.val();
        const div = document.getElementById("medicalData");
        if (!data || !data.visits || data.visits.length === 0) {
          div.innerHTML = "<p>–ú–µ–¥–∫–∞—Ä—Ç–∞ –ø—É—Å—Ç–∞.</p>";
          log("–ú–µ–¥–∫–∞—Ä—Ç–∞ –ø—É—Å—Ç–∞");
          return;
        }
        div.innerHTML = data.visits.reverse().map(v => 
          `<p><b>${v.date}</b><br>ü©∫ –î–∏–∞–≥–Ω–æ–∑: ${v.diagnosis || '‚Äî'}<br>üìù –ó–∞–∫–ª—é—á–µ–Ω–∏–µ: ${v.conclusion || '‚Äî'}<br>üíä –ù–∞–∑–Ω–∞—á–µ–Ω–∏—è: ${v.prescription || '‚Äî'}</p><hr>`
        ).join("");
        log("–ú–µ–¥–∫–∞—Ä—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞");
      })
      .catch(err => {
        log("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–¥–∫–∞—Ä—Ç—ã: " + err.message);
      });
  }

  function addMedicalVisit() {
    const passport = document.getElementById("medPassport")?.value.trim();
    const diagnosis = document.getElementById("medDiagnosis")?.value.trim();
    const conclusion = document.getElementById("medConclusion")?.value.trim();
    const prescription = document.getElementById("medPrescription")?.value.trim();
    if (!passport) {
      alert("–£–∫–∞–∂–∏—Ç–µ –ø–∞—Å–ø–æ—Ä—Ç.");
      return;
    }

    const key = passport.replace(/\s+/g, "_");
    const newVisit = {
      date: new Date().toISOString().split('T')[0],
      diagnosis,
      conclusion,
      prescription,
      doctor: "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä",
      timestamp: Date.now()
    };

    db.ref("medicalRecords/" + key).transaction(record => {
      if (!record) record = { visits: [] };
      record.visits.push(newVisit);
      return record;
    }).then(() => {
      alert("‚úÖ –ó–∞–ø–∏—Å—å –¥–æ–±–∞–≤–ª–µ–Ω–∞!");
      log("–ó–∞–ø–∏—Å—å –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –º–µ–¥–∫–∞—Ä—Ç—É");
      loadMedicalRecord();
      ["medDiagnosis", "medConclusion", "medPrescription"].forEach(id => {
        document.getElementById(id).value = "";
      });
    }).catch(err => {
      log("–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –º–µ–¥–∫–∞—Ä—Ç—É: " + err.message);
      alert("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å.");
    });
  }

  // === –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ===
  function loadStats() {
    db.ref("patients").once("value").then(snap => {
      document.getElementById("statPatients").textContent = snap.numChildren();
    });
    const today = new Date().toISOString().split('T')[0];
    db.ref("appointments").orderByChild("date").equalTo(today).once("value").then(snap => {
      document.getElementById("statAppointments").textContent = snap.numChildren();
    });
  }

  // === –õ–æ–≥–∏ ===
  function clearLog() {
    document.getElementById("systemLog").innerHTML = "";
  }

  // === –ú–∏–Ω. –¥–∞—Ç–∞ ===
  window.addEventListener("load", () => {
    const today = new Date().toISOString().split('T')[0];
    document.querySelectorAll('input[type="date"]').forEach(inp => {
      inp.setAttribute("min", today);
    });
  });

  // === –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –≤ –ª–æ–≥ ===
  log("–°–∏—Å—Ç–µ–º–∞ –∑–∞–ø—É—â–µ–Ω–∞. –û–∂–∏–¥–∞–Ω–∏–µ –≤—Ö–æ–¥–∞...");
</script>
</body>
</html>
